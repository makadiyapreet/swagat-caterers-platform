{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Tracker - Swagat Caterers</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Segoe+UI:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --gold: #D4AF37; --bg: #f8f9fa; --text: #2c3e50; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--text); }

        /* NAV */
        .dashboard-nav { background: #fff; padding: 15px 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); }
        .brand { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 12px; }
        .nav-logo { height: 45px; }
        .back-btn { text-decoration: none; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.06); border-top: 1px solid #eee; margin-bottom: 30px; }
        .card h3 { margin-top: 0; color: #aa8c2c; font-family: 'Playfair Display', serif; font-size: 28px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }

        /* HEADER INPUTS */
        .tracker-header { display: flex; gap: 20px; margin-bottom: 20px; background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 8px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
        .input-group label { font-size: 13px; font-weight: 700; color: #555; text-transform: uppercase; }
        .header-input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; font-size: 14px; }

        /* UNIFORM BUTTON ROW */
        .controls-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            width: 100%;
        }
        
        /* This hides the wrapper divs so buttons become direct children of the flex row */
        .btn-wrapper { display: contents; } 

        .btn-action { 
            flex: 1; /* Makes all buttons equal width */
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 700; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: 14px; 
            white-space: nowrap; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .btn-add { background: #34495e; }
        .btn-report { background: #aa8c2c; }
        .btn-rate { background: #2980b9; } 
        .btn-wipe { background: #c0392b; }
        .btn-save-all { background: var(--gold); color: #000; font-weight: 800; border-bottom: 3px solid #b39028; }

        /* RESPONSIVE TABLE */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top:10px; min-width: 800px; }
        
        th { text-align: left; padding: 15px 10px; background: #f8f9fa; color: #666; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; font-weight: 700; position: sticky; top: 0; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background-color: #fcfcfc; }

        .table-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-weight: 600; color: #333; min-width: 60px; }
        .rate-input { width: 70px; padding: 6px; background: #f4f4f4; border: 1px solid #e0e0e0; border-radius: 4px; text-align: center; color: #555; font-size: 13px; }
        .advance-input { border-color: var(--gold); background: #fffcf5; }
        .settle-wrapper { display: flex; gap: 5px; align-items: center; }
        .settle-input { display: none; width: 80px; padding: 6px; border: 1px solid #27ae60; border-radius: 4px; font-weight: bold; color: #27ae60; }
        .net-due { font-size: 15px; font-weight: 800; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 850px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        .full-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; }
        
        .checkbox-list { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; background: #fdfdfd; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .preview-box { margin-top: 20px; border: 1px solid #eee; padding: 15px; background: #fafafa; border-radius: 8px; display: none; }
        .prev-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .prev-table th, .prev-table td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }

        /* CHART */
        #admin-chart-section { display: none; }
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* --- RESPONSIVE CSS --- */
        @media (max-width: 768px) {
            .controls-row { flex-direction: column; gap: 10px; }
            .btn-action { width: 100%; }
            .dashboard-nav { padding: 15px 20px; flex-direction: column; gap: 10px; }
            .nav-logo { height: 35px; }
            .container { padding: 10px; margin-top: 15px; }
            .card { padding: 15px; }
            .tracker-header { flex-direction: column; align-items: stretch; gap: 15px; padding: 15px; }
            .modal-content { width: 95%; padding: 20px; }
            .checkbox-list { grid-template-columns: 1fr 1fr; }
            .table-responsive { width: 100%; overflow-x: scroll; border: 1px solid #eee; border-radius: 6px; }
        }
    </style>
</head>
<body>

    <nav class="dashboard-nav">
        <div class="brand">
            <img src="{% static 'images/logo/logo.png' %}" class="nav-logo" alt="Logo"> Swagat Caterers
        </div>
        <div><a href="{% url 'dashboard' %}" class="back-btn">&#8592; Back</a></div>
    </nav>

    <div class="container">
        <div id="admin-chart-section" class="card">
            <h3>Staff Overview & Balance</h3>
            <p style="color:#666; font-size:14px; margin-top:-10px; margin-bottom:20px;">
                Visual breakdown of Net Payable amounts (<span style="color:#c0392b; font-weight:bold;">Red</span> = Business Owes Staff) vs Advance Taken (<span style="color:#27ae60; font-weight:bold;">Green</span> = Staff Owes Business).
            </p>
            <div class="chart-container">
                <canvas id="staffChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Daily Member Tracker & Accounts</h3>
            
            <div class="tracker-header">
                <div class="input-group">
                    <label>Entry Date (Mandatory)</label>
                    <input type="date" id="tracker-date" class="header-input">
                </div>
                <div class="input-group">
                    <label>Event Place / Location (Mandatory)</label>
                    <input type="text" id="tracker-place" class="header-input" placeholder="e.g. Grand Hotel">
                </div>
            </div>

            <div class="controls-row">
                <div id="admin-buttons" class="btn-wrapper" style="display:none;">
                    <button class="btn-action btn-add" onclick="openAddMemberModal()"><span>+</span> Add</button>
                    <button class="btn-action btn-report" onclick="openReportModal()"><span>üìÑ</span> Report</button>
                    <button class="btn-action btn-rate" onclick="openRateModal()"><span>‚öôÔ∏è</span> Rates</button>
                    <button class="btn-action btn-wipe" onclick="openWipeModal()"><span>üóëÔ∏è</span> Wipe</button>
                </div>
                <button class="btn-action btn-save-all" onclick="saveAllTrackers()"><span>üíæ</span> Save Changes</button>
            </div>

            <div class="table-responsive">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th style="min-width:150px">Name</th>
                            <th style="min-width:80px">Staff #</th>
                            <th style="min-width:80px">Rate (‚Çπ)</th>
                            <th style="min-width:80px">Total (‚Çπ)</th>
                            <th style="min-width:100px">+ Advance</th>
                            <th style="min-width:120px">Settle Up</th>
                            <th style="min-width:100px">Net Due</th>
                            <th style="min-width:60px">Edit</th>
                        </tr>
                    </thead>
                    <tbody id="member-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="rateModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <h3>Set Custom Rates</h3>
            <div style="max-height:300px; overflow-y:auto;">
                <table class="rate-table" style="width:100%;">
                    <thead><tr><th>Worker Name</th><th>Default Rate (‚Çπ)</th></tr></thead>
                    <tbody id="rate-table-body"></tbody>
                </table>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-modal" style="background:#eee;" onclick="document.getElementById('rateModal').style.display='none'">Cancel</button>
                <button class="btn-modal" style="background:var(--gold); color:white;" onclick="saveCustomRates()">Update Rates</button>
            </div>
        </div>
    </div>

    <div id="wipeModal" class="modal">
        <div class="modal-content" style="max-width:450px; border-top:5px solid #c0392b;">
            <h3 style="color:#c0392b;">Wipe Worker Data</h3>
            <p>Permanently delete worker.</p>
            <select id="wipe-select" class="full-input" style="height:45px;"></select>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-modal" style="background:#eee;" onclick="document.getElementById('wipeModal').style.display='none'">Cancel</button>
                <button class="btn-modal" style="background:#c0392b; color:white;" onclick="executeWipe()">Confirm Wipe</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3>Export Data Report</h3>
            <label><strong>Select Members:</strong></label>
            <div id="member-checkbox-list" class="checkbox-list"></div>
            <br>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex:1; min-width: 150px;"><label>From: <span style="color:red">*</span></label><input type="date" id="report-from" class="full-input"></div>
                <div style="flex:1; min-width: 150px;"><label>To: <span style="color:red">*</span></label><input type="date" id="report-to" class="full-input"></div>
            </div>
            <button onclick="fetchReportData()" style="width:100%; padding:12px; background:#333; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px;">üëÅÔ∏è Get Data & Preview</button>
            
            <div id="preview-wrapper" class="preview-box">
                <div class="table-responsive" style="max-height:300px;">
                    <table class="prev-table">
                        <thead><tr><th>Date</th><th>Place</th><th>Staff</th><th>Rate</th><th>Total</th><th>Adv.</th><th>Settle</th><th>Daily Net</th><th>By</th></tr></thead>
                        <tbody id="preview-tbody"></tbody>
                    </table>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px; flex-wrap: wrap;">
                    <button onclick="downloadPDF()" style="flex:1; padding:10px; background:#aa8c2c; color:white; border:none; border-radius:4px; font-weight:bold;">Download PDF</button>
                    <button onclick="downloadExcel()" style="flex:1; padding:10px; background:#27ae60; color:white; border:none; border-radius:4px; font-weight:bold;">Download Excel</button>
                </div>
            </div>
            <button class="btn-modal" style="background:#eee; margin-top:20px;" onclick="document.getElementById('reportModal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="memberModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h3 id="modal-title">Add New Member</h3>
            <form id="member-form">
                <input type="hidden" id="m-id">
                <label>Name</label><input type="text" id="m-name" class="full-input" required>
                <label>Phone</label><input type="tel" id="m-phone" class="full-input" required>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Rate (‚Çπ)</label><input type="number" id="m-rate" class="full-input" value="500"></div>
                    <div style="flex:1"><label>Open Bal.</label><input type="number" id="m-advance" class="full-input" value="0"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button type="button" class="btn-modal" onclick="document.getElementById('memberModal').style.display='none'" style="background:#eee;">Cancel</button>
                    <button type="submit" class="btn-modal" style="background:var(--gold); color:white;">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const token = localStorage.getItem('authToken');
    if (!token) window.location.href = "{% url 'login' %}";

    // --- 1. CSRF HELPER ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    let members = [];
    let reportData = [];
    let currentUser = "";
    
    // --- ROLE VARIABLES ---
    let isAdmin = false;   // Can see money, rates, charts, edit members
    let isManager = false; // Can only mark attendance (Staff count)

    let staffChart = null; 

    document.getElementById('tracker-date').value = new Date().toISOString().split('T')[0];

    async function init() {
        try {
            const uRes = await fetch('/auth/users/me/', { 
                            headers: { 
                                'Authorization': `Token ${token}`, 
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
            
            if (!uRes.ok) throw new Error("Unauthorized");
            const user = await uRes.json();
            currentUser = user.username;

            // --- ROLE LOGIC ---
            const userType = user.user_type || 'customer';
            isAdmin = (userType === 'admin' || user.is_superuser);
            isManager = (userType === 'manager' || user.is_staff);

            // 1. BLOCK CUSTOMERS
            if (!isAdmin && !isManager) {
                document.body.innerHTML = "<h2 style='text-align:center; padding-top:50px; color:#666;'>Access Denied. Admins and Managers only.</h2>";
                return;
            }

            // 2. UI SETUP BASED ON ROLE
            const adminBtns = document.getElementById('admin-buttons');
            const adminChart = document.getElementById('admin-chart-section');
            const saveBtn = document.getElementById('btn-save-all'); // Assuming your save button has this ID or class

            if(isAdmin) {
                // Admin sees everything
                if(adminBtns) adminBtns.style.display = 'contents'; 
                if(adminChart) adminChart.style.display = 'block';
            } else if (isManager) {
                // Manager only sees the Save button, hides "Add Member/Wipe/Reports"
                // (Note: You might need to adjust your HTML to separate the Save button if it's inside 'admin-buttons')
                if(adminBtns) adminBtns.style.display = 'none'; 
                // We force show the Save button container if hidden
                const saveContainer = document.querySelector('.save-container'); // Add this class to your Save button div in HTML
                if(saveContainer) saveContainer.style.display = 'block';
            }

            fetchMembers();

        } catch(e) { 
            console.error("Auth Error:", e);
            localStorage.removeItem('authToken');
            window.location.href = "{% url 'login' %}"; 
        }
    }

    async function fetchMembers() {
        try { 
        const res = await fetch(`/api/menu/members/?t=${new Date().getTime()}`, { headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken')}});
        members = await res.json();
        
        // Sort Alphabetically
        members.sort((a, b) => a.name.localeCompare(b.name));

        renderMembers();
        if(isAdmin) renderStaffChart();
    } catch (e) { console.error("Fetch Members Error:", e); }
    }

    function renderMembers() {
        const tbody = document.getElementById('member-table');
        tbody.innerHTML = '';
        members.forEach(m => {
            const defaultRate = m.default_rate || 500;
            
            // --- PRIVACY LOGIC ---
            // Managers see placeholder "**" and cannot edit rates
            let rateDisplayAttr = isAdmin ? `value="${defaultRate}"` : `value="" placeholder="**" disabled`;
            let totalDisplay = isAdmin ? "0" : "**";
            let netDisplay = isAdmin ? m.advance_amount : "**";
            let netColor = isAdmin ? (m.advance_amount >= 0 ? '#c0392b' : '#27ae60') : '#555';
            
            // Action Buttons (Edit/Delete) only for Admin
            const actionBtns = isAdmin ? `<button onclick="openEditModal(${m.id})" style="border:none; background:none; cursor:pointer; font-size:18px;">‚úèÔ∏è</button>` : '<span style="color:#ccc">üîí</span>';

            // --- SETTLE UP LOGIC (Admin Only) ---
            let settleDisplay = '';
            if(isAdmin) {
                settleDisplay = `
                    <div class="settle-wrapper">
                        <input type="checkbox" onchange="toggleSettle(${m.id}, this)">
                        <input type="number" class="settle-input inp-settle" placeholder="Amt" oninput="calcRow(${m.id})">
                    </div>`;
            } else {
                settleDisplay = `<span style="color:#aaa; font-size:12px;">üîí</span>`;
            }

            // --- ADVANCE INPUT (Admin Only) ---
            // Managers cannot give advances
            let advInput = (isAdmin || isManager) 
                ? `<input type="number" class="table-input advance-input inp-adv" placeholder="+ Add" oninput="calcRow(${m.id})">`
                : `<input type="text" class="table-input" placeholder="üîí" disabled style="background:#eee;">`;

            tbody.innerHTML += `
                <tr data-id="${m.id}" data-balance="${m.advance_amount}">
                    <td>
                        <div style="font-weight:bold;">${m.name}</div>
                        <div style="font-size:12px; color:#888;">${m.phone}</div>
                    </td>
                    <td><input type="number" class="table-input inp-staff" placeholder="0" min="0" oninput="calcRow(${m.id})"></td>
                    
                    <td><input type="text" class="rate-input inp-rate" ${rateDisplayAttr} readonly style="background:#f0f0f0; color:#888; cursor:not-allowed;"></td>
                    
                    <td><span id="total-${m.id}" class="total-badge">${totalDisplay}</span></td>
                    
                    <td>${advInput}</td>
                    
                    <td>${settleDisplay}</td>
                    
                    <td><span id="net-${m.id}" class="net-due" style="color:${netColor}">${netDisplay}</span></td>
                    
                    <td style="text-align:center;">${actionBtns}</td>
                </tr>`;
        });
    }

    function toggleSettle(id, checkbox) {
        if(!isAdmin) return; // Safety check
        const row = document.querySelector(`tr[data-id="${id}"]`);
        const settleInput = row.querySelector('.inp-settle');
        
        if (checkbox.checked) {
            const staff = parseInt(row.querySelector('.inp-staff').value) || 0;
            const memberData = members.find(m => m.id == id);
            const rate = parseFloat(memberData.default_rate || 500);
            const advance = parseFloat(row.querySelector('.inp-adv').value) || 0;
            const oldBal = parseFloat(row.dataset.balance);
            
            const currentNetBeforeSettle = oldBal + (staff * rate) - advance;
            settleInput.value = currentNetBeforeSettle.toFixed(2);
            settleInput.style.display = 'block';
        } else {
            settleInput.value = '';
            settleInput.style.display = 'none';
        }
        calcRow(id);
    }

    // --- CHART (ADMIN ONLY) ---
    function renderStaffChart() {
        if (!isAdmin) return;

        const ctx = document.getElementById('staffChart').getContext('2d');
        
        const gradientRed = ctx.createLinearGradient(0, 0, 0, 400);
        gradientRed.addColorStop(0, 'rgba(231, 76, 60, 0.7)'); 
        gradientRed.addColorStop(1, 'rgba(192, 57, 43, 0.4)'); 

        const gradientGreen = ctx.createLinearGradient(0, 0, 0, 400);
        gradientGreen.addColorStop(0, 'rgba(46, 204, 113, 0.7)'); 
        gradientGreen.addColorStop(1, 'rgba(39, 174, 96, 0.4)'); 

        const labels = members.map(m => m.name);
        const balanceData = members.map(m => parseFloat(m.advance_amount || 0));
        const phoneData = members.map(m => m.phone);

        const backgroundColors = balanceData.map(val => val >= 0 ? gradientRed : gradientGreen);
        const borderColors = balanceData.map(val => val >= 0 ? '#c0392b' : '#27ae60');

        if (staffChart) staffChart.destroy(); 

        staffChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Net Balance (‚Çπ)',
                        data: balanceData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8, 
                        borderSkipped: false, 
                        barPercentage: 0.6,
                        hoverBackgroundColor: balanceData.map(val => val >= 0 ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)'),
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { 
                            color: (context) => context.tick.value === 0 ? '#000' : 'rgba(0,0,0,0.05)',
                            lineWidth: (context) => context.tick.value === 0 ? 2 : 1
                        },
                        ticks: { font: { weight: 'bold' } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.9)',
                        padding: 12,
                        titleFont: { size: 14 },
                        bodyFont: { size: 14, weight: 'bold' },
                        displayColors: false,
                        callbacks: {
                            title: function(context) { return context[0].label; },
                            afterTitle: function(context) {
                                const index = context[0].dataIndex;
                                return `üìû ${phoneData[index]}`;
                            },
                            label: function(context) {
                                let val = context.parsed.y;
                                let type = val >= 0 ? "Payable" : "Advance Taken";
                                let formattedVal = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(Math.abs(val));
                                return `${type}: ${formattedVal}`;
                            }
                        }
                    }
                }
            }
        });
    }

    function calcRow(id) {
        // If Manager, they can input Staff count, but we don't update totals/net on screen (Privacy)
        if (!isAdmin && !isManager) return;

        const row = document.querySelector(`tr[data-id="${id}"]`);
        const staff = parseInt(row.querySelector('.inp-staff').value) || 0;
        const memberData = members.find(m => m.id == id);
        const rate = memberData ? parseFloat(memberData.default_rate || 500) : 0;
        const advance = parseFloat(row.querySelector('.inp-adv').value) || 0;
        const settle = parseFloat(row.querySelector('.inp-settle').value) || 0;
        const bal = parseFloat(row.dataset.balance);
        
        const total = staff * rate;
        document.getElementById(`total-${id}`).innerText = total;
        
        const newNet = bal + total - advance - settle;
        const netEl = document.getElementById(`net-${id}`);
        netEl.innerText = newNet.toFixed(2);
        netEl.style.color = newNet >= 0 ? '#c0392b' : '#27ae60';
    }

    async function saveAllTrackers() {
        const date = document.getElementById('tracker-date').value;
        const place = document.getElementById('tracker-place').value;
        
        if(!date || !place) return alert("Date and Place are Compulsory!");

        const rows = document.querySelectorAll('#member-table tr');
        const updates = [];
        let count = 0;

        for (const row of rows) {
            const id = row.getAttribute('data-id');
            const staffInput = row.querySelector('.inp-staff');
            
            // Managers might not have these inputs in DOM, so we check safely
            const advInput = row.querySelector('.inp-adv');
            const settleInput = row.querySelector('.inp-settle');

            if (!id || !staffInput) continue;

            const staff = parseInt(staffInput.value) || 0;
            // If input doesn't exist (Manager view), value is 0
            const advance = advInput ? (parseFloat(advInput.value) || 0) : 0;
            const settle = settleInput ? (parseFloat(settleInput.value) || 0) : 0;
            
            // Only proceed if user entered data for this row
            if(staff > 0 || advance > 0 || settle > 0) {
                const memberData = members.find(m => m.id == id);
                // We use data from Memory, not DOM, so it works even if Rate is hidden from Manager
                const rate = memberData ? parseFloat(memberData.default_rate || 500) : 500;
                const total = staff * rate;
                const bal = parseFloat(row.dataset.balance) || 0;
                const newBal = bal + total - advance - settle;
                
                updates.push(fetch(`/api/menu/members/${id}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Token ${token}`, 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        advance_amount: newBal,
                        log_date: date, 
                        log_place: place, 
                        log_staff: staff, 
                        log_rate: rate,
                        log_total: total, 
                        log_advance: advance, 
                        log_settle: settle, 
                        log_entry_by: currentUser
                    })
                }));
                count++;
            }
        }

        if(count === 0) return alert("No entries to save.");

        try {
            const responses = await Promise.all(updates);
            if (responses.some(r => !r.ok)) throw new Error("One or more updates failed.");
            
            alert("Saved Successfully!");
            fetchMembers(); // Refresh table
            // Clear inputs
            document.querySelectorAll('.inp-staff').forEach(i => i.value = '');
            // Only clear financial inputs if they exist (Admin)
            if(isAdmin || isManager) {
                document.querySelectorAll('.inp-adv').forEach(i => i.value = '');
            }
            // Clear Settle ONLY for Admin
            if(isAdmin) {
                document.querySelectorAll('.inp-settle').forEach(i => i.value = '');
            }
        } catch (error) {
            console.error("Save Error:", error);
            alert("Error saving data. Check connection.");
        }
    }

    // ... [Standard Functions] ...
    function openAddMemberModal() {
        if(!isAdmin) return alert("Access Denied");
        document.getElementById('member-form').reset();
        document.getElementById('m-id').value = ""; 
        document.getElementById('modal-title').innerText = "Add New Member";
        document.getElementById('memberModal').style.display = 'flex';
    }

    function openRateModal() {
        if(!isAdmin) return alert("Access Denied");
        const tbody = document.getElementById('rate-table-body');
        tbody.innerHTML = '';
        members.forEach(m => tbody.innerHTML += `<tr data-id="${m.id}"><td>${m.name}</td><td><input type="number" class="rate-edit-input" value="${m.default_rate || 500}" style="width:80px; padding:5px;"></td></tr>`);
        document.getElementById('rateModal').style.display = 'flex';
    }

    async function saveCustomRates() {
        if(!isAdmin) return;
        const rows = document.querySelectorAll('#rate-table-body tr');
        const updates = [];
        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const rate = row.querySelector('.rate-edit-input').value;
            updates.push(fetch(`/api/menu/members/${id}/`, {
                method: 'PATCH',
                headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ default_rate: rate })
            }));
        });
        await Promise.all(updates);
        alert("Rates Updated! Table refreshing...");
        document.getElementById('rateModal').style.display = 'none';
        fetchMembers();
    }

    function openReportModal() {
        if(!isAdmin) return alert("Access Denied");
        const list = document.getElementById('member-checkbox-list');
        list.innerHTML = `<label class="check-item" style="font-weight:bold;"><input type="checkbox" onchange="toggleAll(this)"> Select All</label>`;
        members.forEach(m => {
            list.innerHTML += `<label class="check-item"><input type="checkbox" class="m-check" value="${m.name}"> ${m.name}</label>`;
        });
        document.getElementById('reportModal').style.display = 'flex';
        document.getElementById('preview-wrapper').style.display = 'none';
    }
    function toggleAll(src) { document.querySelectorAll('.m-check').forEach(c => c.checked = src.checked); }

    async function fetchReportData() {
        const from = document.getElementById('report-from').value;
        const to = document.getElementById('report-to').value;
        if(!from || !to) return alert("Select Start and End Date.");

        const checkboxes = document.querySelectorAll('.m-check:checked');
        if(checkboxes.length === 0) return alert("Select at least one member.");
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);

        try {
            const res = await fetch(`/api/menu/logs/?start_date=${from}&end_date=${to}`, {
                headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken')}
            });
            if (!res.ok) throw new Error("API Error.");
            const allLogs = await res.json();
            
            reportData = allLogs.filter(log => selectedNames.includes(log.member_name));
            if (reportData.length === 0) return alert("No records found.");

            reportData.sort((a, b) => {
                if (a.member_name < b.member_name) return -1;
                if (a.member_name > b.member_name) return 1;
                return new Date(a.log_date) - new Date(b.log_date);
            });

            const tbody = document.getElementById('preview-tbody');
            tbody.innerHTML = '';
            reportData.forEach(r => {
                let dailyNet = (parseFloat(r.log_total) - parseFloat(r.log_advance) - parseFloat(r.log_settle)).toFixed(2);
                tbody.innerHTML += `<tr><td>${r.log_date}</td><td>${r.log_place}</td><td>${r.member_name}</td><td>${r.log_staff}</td><td>${r.log_rate}</td><td>${r.log_total}</td><td>${r.log_advance}</td><td>${r.log_settle}</td><td style="font-weight:bold;">${dailyNet}</td><td>${r.log_entry_by}</td></tr>`;
            });
            document.getElementById('preview-wrapper').style.display = 'block';
        } catch (e) { alert("Error fetching data: " + e.message); }
    }

    function getBase64ImageFromUrl(url) {
        return new Promise((resolve, reject) => {
            var img = new Image();
            img.setAttribute("crossOrigin", "anonymous");
            img.onload = () => {
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                var dataURL = canvas.toDataURL("image/png");
                resolve(dataURL);
            };
            img.onerror = () => { resolve(null); }; 
            img.src = url;
        });
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l'); 
        const logoData = await getBase64ImageFromUrl('{% static "images/logo/logo.png" %}');
        const uniqueMembers = [...new Set(reportData.map(r => r.member_name))];

        uniqueMembers.forEach((member, index) => {
            if (index > 0) doc.addPage();

            if(logoData) {
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                doc.saveGraphicsState();
                doc.setGState(new doc.GState({opacity: 0.1})); 
                doc.addImage(logoData, 'PNG', (pageW/2)-50, (pageH/2)-50, 100, 100);
                doc.restoreGraphicsState();
            }

            doc.setFillColor(212, 175, 55); doc.rect(0, 0, 297, 35, 'F');
            doc.setTextColor(255,255,255); doc.setFont("times", "bold"); doc.setFontSize(24);
            doc.text("SWAGAT CATERERS", 14, 22);
            
            doc.setTextColor(0,0,0); doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text(`ACCOUNT STATEMENT: ${member}`, 14, 48);

            const memberLogs = reportData.filter(r => r.member_name === member);
            let totalWork = 0, totalAdv = 0, totalSettle = 0, totalNet = 0;

            const body = memberLogs.map(r => {
                let net = parseFloat(r.log_total) - parseFloat(r.log_advance) - parseFloat(r.log_settle);
                totalWork += parseFloat(r.log_total);
                totalAdv += parseFloat(r.log_advance);
                totalSettle += parseFloat(r.log_settle);
                totalNet += net;
                return [r.log_date, r.log_place, r.log_staff, r.log_rate, r.log_total, r.log_advance, r.log_settle, net.toFixed(2), r.log_entry_by];
            });

            body.push(['', 'TOTALS:', '', '', totalWork.toFixed(2), totalAdv.toFixed(2), totalSettle.toFixed(2), totalNet.toFixed(2), '']);

            doc.autoTable({ 
                startY: 55, 
                head: [['Date','Place','Staff','Rate','Total','Adv','Settle','Daily Net','By']], 
                body: body, 
                theme: 'plain', 
                bodyStyles: { fillColor: false }, 
                headStyles:{fillColor:[44, 62, 80], textColor: 255}, 
                footStyles:{fillColor:[212, 175, 55], textColor: 255}, 
                styles: { fontSize: 10, cellPadding: 3 },
                didParseCell: function (data) { if (data.row.index === body.length - 1) data.cell.styles.fontStyle = 'bold'; }
            });
        });
        doc.save('Swagat_Report.pdf');
    }

    function downloadExcel() {
        const wb = XLSX.utils.book_new();
        const uniqueMembers = [...new Set(reportData.map(r => r.member_name))];

        const borderStyle = {
            top: { style: "thin", color: { rgb: "000000" } },
            bottom: { style: "thin", color: { rgb: "000000" } },
            left: { style: "thin", color: { rgb: "000000" } },
            right: { style: "thin", color: { rgb: "000000" } }
        };

        const headerStyle = {
            font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "D4AF37" } }, 
            alignment: { horizontal: "center", vertical: "center" },
            border: borderStyle
        };
        const nameStyle = { font: { bold: true, sz: 14 }, alignment: { horizontal: "center" }, border: borderStyle };
        const tableHeadStyle = { font: { bold: true }, alignment: { horizontal: "center" }, border: borderStyle };
        const centerStyle = { alignment: { horizontal: "center" }, border: borderStyle };

        uniqueMembers.forEach(member => {
            const memberLogs = reportData.filter(r => r.member_name === member);
            
            const wsData = [
                [{ v: "SWAGAT CATERERS", s: headerStyle }], 
                [{ v: "Statement for: " + member, s: nameStyle }], 
                [], 
                [
                    {v:"Date", s:tableHeadStyle}, {v:"Place", s:tableHeadStyle}, {v:"Staff", s:tableHeadStyle},
                    {v:"Rate", s:tableHeadStyle}, {v:"Total", s:tableHeadStyle}, {v:"Adv.", s:tableHeadStyle},
                    {v:"Settle", s:tableHeadStyle}, {v:"Daily Net", s:tableHeadStyle}, {v:"By", s:tableHeadStyle}
                ]
            ];

            let totalWork = 0, totalAdv = 0, totalSettle = 0, totalNet = 0;

            memberLogs.forEach(r => {
                let net = parseFloat(r.log_total) - parseFloat(r.log_advance) - parseFloat(r.log_settle);
                totalWork += parseFloat(r.log_total);
                totalAdv += parseFloat(r.log_advance);
                totalSettle += parseFloat(r.log_settle);
                totalNet += net;

                wsData.push([
                    { v: r.log_date, s: centerStyle },
                    { v: r.log_place, s: centerStyle },
                    { v: r.log_staff, s: centerStyle },
                    { v: r.log_rate, s: centerStyle },
                    { v: parseFloat(r.log_total), s: centerStyle },
                    { v: parseFloat(r.log_advance), s: centerStyle },
                    { v: parseFloat(r.log_settle), s: centerStyle },
                    { v: parseFloat(net.toFixed(2)), s: centerStyle },
                    { v: r.log_entry_by, s: centerStyle }
                ]);
            });

            wsData.push([
                {v:"", s:centerStyle}, { v: "TOTALS:", s: { font: { bold: true }, border: borderStyle } }, {v:"", s:centerStyle}, {v:"", s:centerStyle},
                { v: totalWork, s: { font: { bold: true }, alignment: { horizontal: "center" }, border: borderStyle } },
                { v: totalAdv, s: { font: { bold: true }, alignment: { horizontal: "center" }, border: borderStyle } },
                { v: totalSettle, s: { font: { bold: true }, alignment: { horizontal: "center" }, border: borderStyle } },
                { v: totalNet, s: { font: { bold: true }, alignment: { horizontal: "center" }, border: borderStyle } },
                {v:"", s:centerStyle}
            ]);

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = Array(9).fill({ wpx: 80 });
            ws['!merges'] = [ { s: {r:0, c:0}, e: {r:0, c:8} }, { s: {r:1, c:0}, e: {r:1, c:8} } ];
            XLSX.utils.book_append_sheet(wb, ws, member.substring(0, 30));
        });

        XLSX.writeFile(wb, "Swagat_Report.xlsx");
    }

    // --- EDIT & WIPE (Admin Only) ---
    function openEditModal(id) {
        if(!isAdmin) return alert("Access Denied");
        const m = members.find(m => m.id === id);
        document.getElementById('m-id').value = m.id;
        document.getElementById('m-name').value = m.name;
        document.getElementById('m-phone').value = m.phone;
        document.getElementById('m-rate').value = m.default_rate || 500;
        document.getElementById('m-advance').value = m.advance_amount;
        document.getElementById('modal-title').innerText = "Edit Member";
        document.getElementById('memberModal').style.display = 'flex';
    }

    function openWipeModal() {
        if(!isAdmin) return alert("Access Denied");
        const select = document.getElementById('wipe-select');
        select.innerHTML = '<option value="">-- Select Worker --</option>';
        members.forEach(m => select.innerHTML += `<option value="${m.id}">${m.name}</option>`);
        document.getElementById('wipeModal').style.display = 'flex';
    }

    async function executeWipe() {
        if(!isAdmin) return;
        const id = document.getElementById('wipe-select').value;
        if(!id) return alert("Select a worker!");
        if(confirm("Confirm Wipe?")) {
            await fetch(`/api/menu/members/${id}/`, { method: 'DELETE', headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken') } });
            alert("Data Wiped.");
            document.getElementById('wipeModal').style.display = 'none';
            fetchMembers();
        }
    }

    document.getElementById('member-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('m-id').value;
        const data = { name: document.getElementById('m-name').value, phone: document.getElementById('m-phone').value, default_rate: document.getElementById('m-rate').value, advance_amount: document.getElementById('m-advance').value };
        const method = id ? 'PATCH' : 'POST';
        const url = id ? `/api/menu/members/${id}/` : '/api/menu/members/';
        await fetch(url, { method: method, headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json','X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(data) });
        document.getElementById('memberModal').style.display = 'none';
        fetchMembers();
    });

    init();
</script>
<script>
    function logoutUser() {
        localStorage.clear();
        window.location.href = "{% url 'login' %}";
    }
</script>
</body>
</html>