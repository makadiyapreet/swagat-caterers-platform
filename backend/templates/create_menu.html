{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Menu Builder - Swagat Caterers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --gold: #D4AF37; --bg: #f4f7f6; --text: #2c3e50; --sidebar-w: 240px; --right-w: 320px; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LAYOUT --- */
        .workspace { display: flex; flex: 1; height: 100%; overflow: hidden; }
        
        /* 1. LEFT SIDEBAR */
        .sidebar-left { width: var(--sidebar-w); background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; }
        .lang-toggle { padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 10px; justify-content: center; background: #fafafa; }
        .lang-btn { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; text-align: center; font-size: 13px; transition: 0.2s; }
        .lang-btn.active { background: var(--gold); color: white; border-color: var(--gold); }
        .search-box { padding: 10px 15px; border-bottom: 1px solid #eee; }
        .search-inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .add-item-btn { margin: 10px 15px; padding: 10px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; display: block; width: calc(100% - 30px); }
        .add-item-btn:hover { background: #34495e; }
        .cat-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .cat-item { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #555; border-left: 4px solid transparent; transition: 0.2s; display: flex; justify-content: space-between; font-size: 14px; }
        .cat-item:hover { background: #f9f9f9; color: var(--gold); }
        .cat-item.active { background: #fff8e1; color: #b59020; border-left-color: var(--gold); }
        .cat-count { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 11px; color: #777; }

        /* 2. CENTER AREA */
        .main-area { flex: 1; display: flex; flex-direction: column; background: #f4f7f6; min-width: 0; position: relative; }
        
        .top-bar { background: white; padding: 15px 25px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        /* INFO GRID INPUTS */
        .info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .info-input-group label { display: block; font-size: 10px; font-weight: bold; text-transform: uppercase; color: #888; margin-bottom: 2px; }
        .info-input { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; font-weight: 600; color: #333; box-sizing: border-box; }

        .menu-config { display: flex; gap: 15px; align-items: center; margin-top: 5px; flex-wrap: wrap; border-top: 1px solid #eee; padding-top: 10px; }
        .input-group { position: relative; }
        .input-group label { display: block; font-size: 10px; font-weight: bold; text-transform: uppercase; color: #888; margin-bottom: 2px; }
        .config-input, .config-select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; width: 140px; font-weight: bold; font-size: 14px; }
        .config-select { width: 160px; }
        .config-input:disabled { background: #eee; color: #888; cursor: not-allowed; }
        .config-textarea { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; width: 100%; font-weight: bold; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box; }

        .mode-selector-container { display:flex; justify-content:space-between; align-items:center; width:100%; }
        .mode-selector { padding: 8px 12px; border: 2px solid var(--gold); border-radius: 6px; background: #fffcf5; font-weight: bold; color: #b59020; cursor: pointer; font-size: 14px; }

        .items-container { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 100px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--gold); border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .item-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; cursor: pointer; transition: 0.2s; position: relative; }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .item-card.selected { border-color: var(--gold); background: #fffcf5; box-shadow: 0 0 0 1px var(--gold); }
        .item-name { font-weight: 600; font-size: 14px; color: #333; display: block; }
        .item-sub { font-size: 12px; color: #888; margin-top: 2px; display: block; }
        .check-icon { position: absolute; top: 10px; right: 10px; color: var(--gold); display: none; }
        .item-card.selected .check-icon { display: block; }

        /* QUICK ADD FOOTER */
        .quick-add-footer {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #ddd; padding: 15px 25px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 5;
        }
        .quick-add-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .quick-input-group { flex: 1; }
        .quick-input-group label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }

        /* 3. RIGHT SIDEBAR */
        .sidebar-right { width: var(--right-w); background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.02); }
        .preview-header { padding: 15px; border-bottom: 1px solid #eee; background: #fafafa; text-align: center; }
        .preview-title { font-weight: bold; color: #333; font-size: 16px; margin: 0; }
        .selected-list { flex: 1; overflow-y: auto; padding: 15px; }
        .sel-category { margin-bottom: 15px; }
        .sel-cat-title { font-size: 12px; font-weight: 700; color: var(--gold); text-transform: uppercase; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 3px; }
        .sel-item { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; border-bottom: 1px dashed #f5f5f5; }
        .sel-remove { color: #c0392b; cursor: pointer; font-weight: bold; margin-left: 10px; opacity: 0.5; }
        .sel-remove:hover { opacity: 1; }
        .action-area { padding: 20px; border-top: 1px solid #eee; background: #fff; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-save { background: var(--gold); color: white; }
        .btn-save:hover { background: #b59020; }
        .btn-update { background: #e67e22; color: white; border: 1px solid #d35400; }
        .btn-update:hover { background: #d35400; }
        .btn-print { background: #2c3e50; color: white; }
        .btn-print:hover { background: #1a252f; }
        .btn-back { background: #eee; color: #333; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { margin-top: 0; font-family: 'Playfair Display', serif; color: var(--gold); }
        .modal-form label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; margin-top: 10px; }
        .modal-form input, .modal-form select, .modal-form textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .add-mode-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .add-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 13px; font-weight: bold; color: #777; }
        .add-tab.active { color: var(--gold); border-bottom: 2px solid var(--gold); }

        /* --- RESPONSIVE DESIGN (MOBILE & TABLET) --- */
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .workspace { flex-direction: column; overflow: visible; height: auto; }
            
            /* REORDERING: Flatten main area to reorder its children separately */
            .main-area { display: contents; } 

            /* 1. Menu Details on TOP */
            .top-bar { order: 1; border-bottom: 5px solid var(--gold); } 
            
            /* 2. Sidebar (Categories/Search) BELOW Details */
            .sidebar-left { 
                order: 2; 
                width: 100%; 
                border-right: none; 
                height: auto; 
                padding-bottom: 10px; 
            } 
            
            /* 3. Items Grid BELOW Sidebar */
            .items-container { 
                order: 3; 
                padding: 10px; 
                height: auto; 
                overflow: visible; 
                padding-bottom: 20px; 
            } 
            
            /* 4. Footer (Custom Add) BELOW Grid */
            .quick-add-footer { 
                order: 4; 
                position: relative; 
                width: 100%; 
                box-sizing: border-box; 
                bottom: auto; 
                margin-top: 10px;
                padding: 15px;
            } 
            
            /* 5. Right Sidebar (Preview) LAST */
            .sidebar-right { order: 5; width: 100%; height: auto; border-left: none; } 

            /* Horizontal Category List */
            .cat-list { display: flex; overflow-x: auto; padding: 10px; white-space: nowrap; gap: 10px; }
            .cat-item { border: 1px solid #ccc; border-radius: 20px; padding: 8px 15px; margin: 0; background: white; }
            .cat-item.active { background: var(--gold); color: white; border-color: var(--gold); }

            /* Full Width Custom Add Inputs */
            .quick-add-wrapper { flex-direction: column; gap: 10px; }
            .quick-input-group { width: 100%; }
            #quick-add-inp { width: 100% !important; box-sizing: border-box; }
            .quick-add-wrapper button { width: 100%; margin: 0; }
            
            /* Responsive Inputs */
            .info-grid { grid-template-columns: 1fr; gap: 10px; }
            .menu-config { flex-direction: column; align-items: stretch; }
            .input-group, .config-input, .config-select { width: 100%; box-sizing: border-box; }
            .modal-box { width: 90%; }
        }
    </style>
</head>
<body>

    <div class="workspace">
        <div class="sidebar-left">
            <div class="lang-toggle">
                <div class="lang-btn active" id="lang-en" onclick="setLang('en')">English</div>
                <div class="lang-btn" id="lang-gu" onclick="setLang('gu')">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</div>
            </div>
            <div class="search-box">
                <input type="text" id="cat-search" class="search-inp" placeholder="Search Items..." onkeyup="filterGrid()">
            </div>
            <button class="add-item-btn" onclick="openAddItemModal()">+ Add New Item to DB</button>
            <div class="cat-list" id="category-list"></div>
        </div>

        <div class="main-area">
            <div class="top-bar">
                <div class="mode-selector-container">
                    <h3 style="margin:0; color:var(--text); font-family:'Playfair Display', serif;">Menu Details</h3>
                    <div style="text-align: right;">
                        <label style="font-size:10px; font-weight:bold; color:#888; display:block; margin-bottom:2px;">EDITING MODE</label>
                        <select id="edit-mode-select" class="mode-selector" onchange="switchEditMode()">
                            <option value="new">‚ú® Create New Menu</option>
                        </select>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-input-group">
                        <label>Client Name</label>
                        <input type="text" id="ev-name" class="info-input" placeholder="Client Name">
                    </div>
                    <div class="info-input-group">
                        <label>Date (DD-MM-YYYY)</label>
                        <input type="text" id="ev-date" class="info-input" placeholder="DD-MM-YYYY">
                    </div>
                    <div class="info-input-group">
                        <label>Dish / Guests</label>
                        <input type="text" id="ev-guests" class="info-input" placeholder="e.g. 500">
                    </div>
                     <div class="info-input-group">
                        <label>Contact Number</label>
                        <input type="text" id="ev-contact" class="info-input" placeholder="Contact No.">
                    </div>
                </div>
                
                <div class="info-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="info-input-group" style="grid-column: span 2;">
                        <label>Venue Address</label>
                        <input type="text" id="ev-venue" class="info-input" placeholder="Enter Venue Address">
                    </div>
                     <div class="input-group">
                        <label>Menu Type</label>
                        <select id="menu-title" class="info-input" style="height:32px;">
                            <option value="Lunch">Lunch</option>
                            <option value="High Tea">High Tea</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Breakfast">Breakfast</option>
                            <option value="Packet">Packet / Box</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="menu-config">
                    <div class="input-group">
                        <label>Price / Plate (‚Çπ)</label>
                        <input type="number" id="menu-price" class="config-input" placeholder="0.00">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label>Special Note (Optional)</label>
                        <textarea id="menu-note" class="config-textarea" rows="1" placeholder="e.g., Less spicy, Jain food separate..."></textarea>
                    </div>
                </div>
            </div>

            <div class="items-container" id="items-grid-container">
                <p style="text-align:center; color:#999; margin-top:100px;">Select a category from the left to view items.</p>
            </div>

            <div class="quick-add-footer">
                <div class="quick-add-wrapper">
                    <div class="quick-input-group">
                        <label id="quick-add-label">Add Custom Items (Text Only)</label>
                        <input type="text" id="quick-add-inp" class="search-inp" placeholder="Type items here (e.g. Special Dish) to add to CURRENT category...">
                    </div>
                    <button class="btn-action btn-save" style="width: auto; margin-bottom:0;" onclick="addQuickItems()">Add to List</button>
                </div>
            </div>
        </div>

        <div class="sidebar-right">
            <div class="preview-header">
                <h3 class="preview-title">Selected Items (<span id="total-count">0</span>)</h3>
            </div>
            
            <div class="selected-list" id="selected-preview">
                <p style="color:#999; text-align:center; padding:20px; font-size:13px;">No items selected yet.</p>
            </div>

            <div class="action-area">
                <button id="btn-main-save" class="btn-action btn-save" onclick="saveMenu()">üíæ Save Menu</button>
                <div style="display:flex; gap:5px;">
                    <button class="btn-action btn-print" onclick="downloadPDF('en')">üñ®Ô∏è ENG PDF</button>
                    <button class="btn-action btn-print" onclick="downloadPDF('gu')">üñ®Ô∏è GUJ PDF</button>
                </div>
                <button class="btn-action btn-back"
                        data-url="{% url 'dashboard' %}"
                        onclick="window.location.href=this.dataset.url">
                    Back to Dashboard
                </button>
            </div>
        </div>
    </div>

    <div id="addItemModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Add New Item(s) to Database</h3>
            <div class="add-mode-tabs">
                <div class="add-tab active" onclick="switchAddTab('single')" id="tab-single">Single Item</div>
                <div class="add-tab" onclick="switchAddTab('bulk')" id="tab-bulk">Bulk Add (Text)</div>
            </div>
            <div class="modal-form">
                <label>Category *</label>
                <select id="new-item-cat">
                    <option value="" disabled selected>-- Select Category --</option>
                </select>
                <div id="mode-single">
                    <label>English Name *</label>
                    <input type="text" id="new-item-en" placeholder="e.g. Paneer Tikka">
                    <label>Gujarati Name (Optional)</label>
                    <input type="text" id="new-item-gu" placeholder="e.g. ‡™™‡™®‡´Ä‡™∞ ‡™ü‡™ø‡™ï‡´ç‡™ï‡™æ">
                </div>
                <div id="mode-bulk" style="display:none;">
                    <label>Items (One per line) *</label>
                    <textarea id="bulk-item-text" rows="6" placeholder="Paneer Tikka | ‡™™‡™®‡´Ä‡™∞ ‡™ü‡™ø‡™ï‡´ç‡™ï‡™æ&#10;Dal Fry&#10;Jeera Rice"></textarea>
                </div>
            </div>
            <div class="modal-btns">
                <button class="btn-action btn-save" onclick="submitNewItems()">Save to Database</button>
                <button class="btn-action btn-back" onclick="closeAddItemModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('authToken');
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event_id');
        const urlMenuId = urlParams.get('menu_id');

        const dashboardUrl = "{% url 'dashboard' %}";
        if (!token || !eventId) window.location.href = dashboardUrl;

        let allItems = [];
        let categories = [];
        let eventData = {};
        let selectedIds = new Set();
        let customItems = []; 
        let currentLang = 'en';
        let activeCategoryId = null;
        let isAdmin = false;
        let currentMenuId = null;
        let currentAddMode = 'single';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- DATE FORMATTER (YYYY-MM-DD -> DD-MM-YYYY) ---
        function formatDateDisplay(dStr) {
            if(!dStr) return "";
            try {
                const p = dStr.split('-');
                if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; // Swap YYYY and DD
            } catch(e){}
            return dStr;
        }

        // --- INIT ---
        async function init() {
            try {
                const uRes = await fetch('/auth/users/me/', { headers: { 'Authorization': `Token ${token}` ,'X-CSRFToken': getCookie('csrftoken') } });
                if (!uRes.ok) throw new Error("Auth Failed");
                const user = await uRes.json();
                isAdmin = user.is_staff || user.is_superuser;
                
                const priceInput = document.getElementById('menu-price');
                if (!isAdmin) { priceInput.value = "**"; priceInput.disabled = true; priceInput.type = "password"; } 
                else { priceInput.disabled = false; priceInput.type = "number"; }

                const cRes = await fetch('/api/menu/categories/', { headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken') } });
                categories = await cRes.json();

                const iRes = await fetch('/api/menu/menu-items/', { headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken') } });
                allItems = await iRes.json();

                const eRes = await fetch(`/api/menu/events/${eventId}/`, { headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken') } });
                eventData = await eRes.json();
                
                document.getElementById('ev-name').value = eventData.title || "";
                
                // FORMAT DATE FOR INPUT (DD-MM-YYYY)
                document.getElementById('ev-date').value = formatDateDisplay(eventData.date) || "";
                
                document.getElementById('ev-guests').value = eventData.guests || "";
                document.getElementById('ev-venue').value = eventData.venue || ""; 
                document.getElementById('ev-contact').value = eventData.contact_number || ""; 
                
                renderSidebar();
                updateEditDropdown(); 

                if(categories.length > 0) selectCategory(categories[0].id);

                if(urlMenuId) {
                    document.getElementById('edit-mode-select').value = urlMenuId;
                    switchEditMode();
                }

            } catch (e) { console.error("Init Error:", e); }
        }

        // --- HELPERS ---
        function addQuickItems() {
            if (!activeCategoryId || activeCategoryId === 'all') return alert("‚ö†Ô∏è Please select a specific category.");
            const input = document.getElementById('quick-add-inp');
            const text = input.value.trim();
            if(!text) return;
            const newItems = text.split(',').map(s => s.trim()).filter(s => s !== "");
            newItems.forEach(itemName => {
                const exists = customItems.some(ci => ci.name === itemName && ci.categoryId == activeCategoryId);
                if(!exists) customItems.push({ name: itemName, categoryId: activeCategoryId });
            });
            input.value = ""; renderPreview();
        }
        function removeCustomItem(name, catId) { customItems = customItems.filter(i => !(i.name === name && i.categoryId == catId)); renderPreview(); }
        
        function openAddItemModal() {
            const catSelect = document.getElementById('new-item-cat');
            catSelect.innerHTML = '<option value="" disabled selected>-- Select Category --</option>';
            categories.forEach(cat => { catSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`; });
            if(activeCategoryId && activeCategoryId !== 'all') catSelect.value = activeCategoryId;
            document.getElementById('addItemModal').style.display = 'flex';
        }
        function closeAddItemModal() { document.getElementById('addItemModal').style.display = 'none'; }
        function switchAddTab(mode) {
            currentAddMode = mode;
            document.getElementById('tab-single').className = mode === 'single' ? 'add-tab active' : 'add-tab';
            document.getElementById('tab-bulk').className = mode === 'bulk' ? 'add-tab active' : 'add-tab';
            document.getElementById('mode-single').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('mode-bulk').style.display = mode === 'bulk' ? 'block' : 'none';
        }

        async function submitNewItems() {
            const categoryId = document.getElementById('new-item-cat').value;
            if(!categoryId) return alert("Please select a Category first.");
            let itemsToCreate = [];
            if (currentAddMode === 'single') {
                const name = document.getElementById('new-item-en').value;
                const gujName = document.getElementById('new-item-gu').value;
                if(!name) return alert("English Name is required");
                itemsToCreate.push({ name: name, gujarati_name: gujName, category: parseInt(categoryId), is_available: true });
            } else {
                const text = document.getElementById('bulk-item-text').value;
                if(!text.trim()) return alert("Enter at least one item");
                const lines = text.split('\n');
                lines.forEach(line => {
                    if(line.trim()) {
                        const parts = line.split('|');
                        itemsToCreate.push({ name: parts[0].trim(), gujarati_name: parts[1] ? parts[1].trim() : "", category: parseInt(categoryId), is_available: true });
                    }
                });
            }
            for (let itemData of itemsToCreate) {
                const formData = new FormData();
                formData.append('name', itemData.name);
                if(itemData.gujarati_name) formData.append('gujarati_name', itemData.gujarati_name);
                formData.append('category', itemData.category);
                formData.append('is_available', 'true');
                const res = await fetch('/api/menu/menu-items/', { method: 'POST', headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken') }, body: formData });
                if(res.ok) {
                    const newItem = await res.json();
                    allItems.push(newItem);
                    selectedIds.add(newItem.id);
                }
            }
            closeAddItemModal(); selectCategory(parseInt(categoryId)); renderSidebar(); renderPreview();
        }

        // --- RENDERERS ---
        function updateEditDropdown() {
            const select = document.getElementById('edit-mode-select');
            select.innerHTML = '<option value="new">‚ú® Create New Menu</option>';
            if(eventData.menus && eventData.menus.length > 0) {
                eventData.menus.forEach(m => { select.innerHTML += `<option value="${m.id}">‚úèÔ∏è Edit: ${m.title}</option>`; });
            }
        }
        async function switchEditMode() {
            const val = document.getElementById('edit-mode-select').value;
            const saveBtn = document.getElementById('btn-main-save');
            customItems = []; 
            if (val === 'new') {
                currentMenuId = null; selectedIds.clear();
                document.getElementById('menu-title').value = "Lunch"; 
                document.getElementById('menu-note').value = ""; 
                if(isAdmin) document.getElementById('menu-price').value = "";
                saveBtn.innerText = "üíæ Save Menu"; saveBtn.className = "btn-action btn-save";
            } else {
                currentMenuId = val;
                const menuToEdit = eventData.menus.find(m => m.id == currentMenuId);
                if (menuToEdit) {
                    selectedIds.clear();
                    menuToEdit.items.forEach(id => selectedIds.add(id));
                    document.getElementById('menu-title').value = menuToEdit.title;
                    document.getElementById('menu-note').value = menuToEdit.note || "";
                    if(isAdmin) document.getElementById('menu-price').value = menuToEdit.price_per_plate;
                    saveBtn.innerText = "üîÑ Update Menu"; saveBtn.className = "btn-action btn-update";
                }
            }
            renderMainGrid(); renderPreview();
        }
        function renderSidebar() {
            const list = document.getElementById('category-list');
            list.innerHTML = `<div class="cat-item" onclick="selectCategory('all')" id="cat-all"><span>All Items</span><span class="cat-count">${allItems.length}</span></div>`;
            categories.forEach(cat => {
                const count = allItems.filter(i => i.category == cat.id).length;
                let name = currentLang === 'gu' && cat.gujarati_name ? cat.gujarati_name : cat.name;
                list.innerHTML += `<div class="cat-item" onclick="selectCategory(${cat.id})" id="cat-${cat.id}"><span>${name}</span><span class="cat-count">${count}</span></div>`;
            });
        }
        function selectCategory(catId) {
            activeCategoryId = catId;
            document.querySelectorAll('.cat-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`cat-${catId}`)) document.getElementById(`cat-${catId}`).classList.add('active');
            
            const footerLabel = document.getElementById('quick-add-label');
            const footerInput = document.getElementById('quick-add-inp');
            if(catId === 'all') {
                footerLabel.innerText = "Select a Category to Add Custom Items";
                footerInput.disabled = true; footerInput.placeholder = "Please select a specific category...";
            } else {
                const cat = categories.find(c => c.id == catId);
                const cName = cat ? cat.name : "Category";
                footerLabel.innerText = `Add Custom Items to: ${cName} (Not saved to DB)`;
                footerInput.disabled = false; footerInput.placeholder = `Type items for ${cName}...`;
            }
            renderMainGrid();
        }
        function renderMainGrid() {
            const container = document.getElementById('items-grid-container');
            const search = document.getElementById('cat-search').value.toLowerCase();
            let filtered = allItems;
            if (activeCategoryId && activeCategoryId !== 'all') filtered = allItems.filter(i => i.category == activeCategoryId);
            if (search) filtered = filtered.filter(i => i.name.toLowerCase().includes(search) || (i.gujarati_name && i.gujarati_name.includes(search)));
            if (filtered.length === 0) { container.innerHTML = `<p style="text-align:center; color:#999; margin-top:50px;">No items found.</p>`; return; }
            let title = "All Items";
            if(activeCategoryId && activeCategoryId !== 'all') {
                const cat = categories.find(c => c.id == activeCategoryId);
                if(cat) title = currentLang === 'gu' && cat.gujarati_name ? cat.gujarati_name : cat.name;
            }
            let html = `<div class="section-title">${title}</div><div class="items-grid">`;
            filtered.forEach(item => {
                const isSelected = selectedIds.has(item.id);
                const mainName = currentLang === 'gu' && item.gujarati_name ? item.gujarati_name : item.name;
                const subName = currentLang === 'gu' ? item.name : (item.gujarati_name || '');
                html += `<div class="item-card ${isSelected ? 'selected' : ''}" onclick="toggleItem(${item.id})"><div class="check-icon">‚úî</div><span class="item-name">${mainName}</span><span class="item-sub">${subName}</span></div>`;
            });
            html += `</div>`; container.innerHTML = html;
        }
        function toggleItem(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderMainGrid(); renderPreview(); }
        function renderPreview() {
            const container = document.getElementById('selected-preview');
            document.getElementById('total-count').innerText = selectedIds.size + customItems.length;
            if (selectedIds.size === 0 && customItems.length === 0) { container.innerHTML = '<p style="color:#999; text-align:center; padding:20px; font-size:13px;">No items selected yet.</p>'; return; }
            let html = '';
            categories.forEach(cat => {
                const dbItems = allItems.filter(i => i.category == cat.id && selectedIds.has(i.id));
                const custItems = customItems.filter(i => i.categoryId == cat.id);
                if (dbItems.length > 0 || custItems.length > 0) {
                    let catName = currentLang === 'gu' && cat.gujarati_name ? cat.gujarati_name : cat.name;
                    html += `<div class="sel-category"><div class="sel-cat-title">${catName}</div>`;
                    dbItems.forEach(item => {
                        let itemName = currentLang === 'gu' && item.gujarati_name ? item.gujarati_name : item.name;
                        html += `<div class="sel-item"><span>${itemName}</span><span class="sel-remove" onclick="toggleItem(${item.id})">&times;</span></div>`;
                    });
                    custItems.forEach(cItem => {
                         html += `<div class="sel-item"><span style="color:#d35400;">‚òÖ ${cItem.name}</span><span class="sel-remove" onclick="removeCustomItem('${cItem.name}', ${cat.id})">&times;</span></div>`;
                    });
                    html += `</div>`;
                }
            });
            container.innerHTML = html;
        }
        function setLang(lang) {
            currentLang = lang;
            document.getElementById('lang-en').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('lang-gu').className = lang === 'gu' ? 'lang-btn active' : 'lang-btn';
            renderSidebar(); renderMainGrid(); renderPreview();
        }
        function filterGrid() { renderMainGrid(); }
        
        async function saveMenu() {
            const title = document.getElementById('menu-title').value;
            let price = isAdmin ? document.getElementById('menu-price').value : 0;
            const note = document.getElementById('menu-note').value;
            if(!title) return alert("Please select Menu Name");
            if(selectedIds.size === 0 && customItems.length === 0) return alert("Select at least one item.");
            const payload = { event: eventId, title: title, price_per_plate: price || 0, items: Array.from(selectedIds), custom_items_text: customItems, note: note };
            try {
                let url = '/api/menu/menus/'; let method = 'POST';
                if (currentMenuId) { url = `/api/menu/menus/${currentMenuId}/`; method = 'PATCH'; }
                const res = await fetch(url, { method: method, headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' , 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(payload) });
                if(res.ok) {
                    alert(currentMenuId ? "‚úÖ Menu Updated!" : "‚úÖ Menu Created!");
                    const newMenu = await res.json();
                    document.getElementById('edit-mode-select').value = newMenu.id; 
                    updateEditDropdown();
                    currentMenuId = newMenu.id;
                } else { alert("Error saving menu."); }
            } catch(e) { console.error(e); alert("Network Error"); }
        }

        // --- PDF GENERATOR (UPDATED - NO COVER/BACK) ---
        async function downloadPDF(lang) {
            if (selectedIds.size === 0 && customItems.length === 0) return alert("Select items first.");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // --- LOAD ASSETS (Only Background Needed) ---
            let fontBase64 = null, bgBase64 = null;
            async function loadImage(url) {
                try {
                    const r = await fetch(url);
                    if (r.ok) {
                        const b = await r.blob();
                        return new Promise(res => {
                            const read = new FileReader();
                            read.onloadend = () => res(read.result);
                            read.readAsDataURL(b);
                        });
                    }
                } catch (e) {}
                return null;
            }

            try {
                // Load Background Image
                bgBase64 = await loadImage('{% static "images/background.png" %}');

                if (lang === 'gu') {
                    const response = await fetch('{% static "Gujarati.ttf" %}');
                    if (!response.ok) throw new Error("Missing Gujarati.ttf");
                    const blob = await response.blob();
                    const reader = new FileReader();
                    await new Promise(resolve => { reader.onloadend = () => resolve(reader.result); reader.readAsDataURL(blob); });
                    fontBase64 = reader.result.split(',')[1];
                    doc.addFileToVFS('Gujarati.ttf', fontBase64);
                    doc.addFont('Gujarati.ttf', 'Gujarati', 'normal');
                    doc.setFont('Gujarati');
                } else { doc.setFont("helvetica", "normal"); }
            } catch (e) { return alert("Error loading assets: " + e.message); }

            // --- DATA ---
            const dName = document.getElementById('ev-name').value || "-";
            const dDateRaw = document.getElementById('ev-date').value || ""; 
            const dDish = document.getElementById('ev-guests').value || "-";
            const dVenue = document.getElementById('ev-venue').value || "-";
            const dContact = document.getElementById('ev-contact').value || "-";
            const dMenuType = document.getElementById('menu-title').value || "Menu";
            let dPrice = isAdmin ? document.getElementById('menu-price').value : "0";

            // --- HELPER: BACKGROUND & GRID ---
            function drawLayoutAndGrid() {
                if(bgBase64) doc.addImage(bgBase64, 'PNG', 0, 0, 210, 297);
                
                const startY = 43; 
                const rowHeight = 6; 
                
                doc.setDrawColor(212, 175, 55); 
                doc.setLineWidth(0.5);
                doc.line(15, startY, 195, startY);

                if(lang !== 'gu') doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                
                // Row 1
                const row1Y = startY + 5;
                doc.setTextColor(212, 175, 55); doc.text("Name :", 20, row1Y);
                doc.setTextColor(0, 0, 0);      doc.text(dName, 35, row1Y);
                
                doc.setTextColor(212, 175, 55); doc.text("Dish :", 90, row1Y);
                doc.setTextColor(0, 0, 0);      doc.text(dDish, 105, row1Y);

                doc.setTextColor(212, 175, 55); doc.text("Rate :", 150, row1Y);
                doc.setTextColor(0, 0, 0);      doc.text(dPrice, 165, row1Y);

                // Row 2
                const row2Y = row1Y + rowHeight;
                doc.setTextColor(212, 175, 55); doc.text("Date :", 20, row2Y);
                doc.setTextColor(0, 0, 0);      doc.text(dDateRaw, 35, row2Y);
                
                doc.setTextColor(212, 175, 55); doc.text("Contact :", 90, row2Y);
                // X=112 to prevent overlap
                doc.setTextColor(0, 0, 0);      doc.text(dContact, 112, row2Y);

                doc.setTextColor(212, 175, 55); doc.text("Event :", 150, row2Y);
                doc.setTextColor(0, 0, 0);      doc.text(dMenuType, 165, row2Y);

                // Row 3
                const row3Y = row2Y + rowHeight;
                doc.setTextColor(212, 175, 55); doc.text("Venue :", 20, row3Y);
                doc.setTextColor(0, 0, 0);      doc.text(dVenue, 35, row3Y);

                const endY = row3Y + 3; 
                doc.setDrawColor(212, 175, 55); 
                doc.line(15, endY, 195, endY);

                if(lang !== 'gu') doc.setFont("helvetica", "normal"); 
                return endY + 12; 
            }

            function drawHeader(text, x, y) {
                doc.setFillColor(198, 153, 79); 
                doc.roundedRect(x, y - 6, 80, 8, 3, 3, 'F');
                doc.setTextColor(0,0,0); 
                doc.setFontSize(11);
                if(lang !== 'gu') doc.setFont("helvetica", "bold");
                doc.text(text, x + 5, y - 1);
                if(lang !== 'gu') doc.setFont("helvetica", "normal");
            }

            // --- RENDER CONTENT ---
            let startContentY = drawLayoutAndGrid();
            let xLeft = 15;
            let xRight = 110;
            let currentX = xLeft;
            let currentY = startContentY;
            let maxY = 275; 
            let itemLineHeight = 6;
            let headerHeight = 10;

            function checkPageBreak(heightNeeded) {
                if (currentY + heightNeeded > maxY) {
                    if (currentX === xLeft) { 
                        currentX = xRight; 
                        currentY = startContentY; 
                    } else { 
                        doc.addPage();
                        let newStartY = drawLayoutAndGrid(); 
                        currentX = xLeft; 
                        currentY = newStartY; 
                    }
                }
            }

            for (let i = 0; i < categories.length; i++) {
                const cat = categories[i];
                const dbItems = allItems.filter(item => item.category == cat.id && selectedIds.has(item.id));
                const custItems = customItems.filter(item => item.categoryId == cat.id);
                const totalItems = [...dbItems, ...custItems];

                if (totalItems.length === 0) continue;

                const blockHeight = headerHeight + (totalItems.length * itemLineHeight) + 5;
                checkPageBreak(blockHeight);

                let catName = (lang==='gu' && cat.gujarati_name) ? cat.gujarati_name : cat.name;
                drawHeader(catName, currentX, currentY);
                currentY += headerHeight;

                doc.setTextColor(0,0,0); doc.setFontSize(10);
                totalItems.forEach(item => {
                    let itemName = item.categoryId ? item.name : ((lang==='gu' && item.gujarati_name) ? item.gujarati_name : item.name);
                    doc.text(itemName, currentX + 5, currentY);
                    currentY += itemLineHeight;
                });
                currentY += 5;
            }

            // 4. ATTRACTIVE SPECIAL NOTE FOOTER
            const noteText = document.getElementById('menu-note').value;
            if (noteText) {
                const noteHeader = lang === 'gu' ? '‡™µ‡™ø‡™∂‡´á‡™∑ ‡™®‡´ã‡™Ç‡™ß' : 'SPECIAL NOTE';
                const noteLines = doc.splitTextToSize(noteText, 170); 
                
                const headerH = 8;
                const padding = 6;
                const textBlockH = (noteLines.length * 6);
                const boxHeight = headerH + textBlockH + padding;
                
                const pageHeight = 297; 
                const bottomMargin = 15; 
                let footerY = pageHeight - bottomMargin - boxHeight;

                if (currentY > footerY) {
                    doc.addPage();
                    drawLayoutAndGrid(); 
                    footerY = pageHeight - bottomMargin - boxHeight;
                }

                // Box
                doc.setFillColor(255, 252, 245); doc.setDrawColor(198, 153, 79); doc.setLineWidth(0.5);
                doc.roundedRect(15, footerY, 180, boxHeight, 3, 3, 'FD');

                // Header
                doc.setFillColor(198, 153, 79); 
                doc.roundedRect(15, footerY, 180, headerH, 2, 2, 'F');
                doc.rect(15, footerY + headerH - 2, 180, 2, 'F'); 

                doc.setTextColor(255,255,255); doc.setFontSize(11);
                if(lang !== 'gu') doc.setFont("helvetica", "bold");
                doc.text(noteHeader, 105, footerY + 5.5, { align: 'center' }); 

                doc.setTextColor(0,0,0); doc.setFontSize(10);
                if(lang !== 'gu') doc.setFont("helvetica", "normal");
                doc.text(noteLines, 20, footerY + headerH + 6); 
            }

            // Filename Date
            const safeTitle = dName.replace(/[^a-zA-Z0-9 ]/g, "").trim();
            const fileDate = dDateRaw.replace(/\//g, "-");
            doc.save(`${safeTitle} - ${fileDate} - SwagatCaterers.pdf`);
        }

        init();
    </script>
</body>
</html>