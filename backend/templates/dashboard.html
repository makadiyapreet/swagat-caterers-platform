{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Swagat Caterers</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Segoe+UI:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --gold: #D4AF37; --dark-gold: #aa8c2c; --bg: #f8f9fa; --text: #2c3e50; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--text); }

        /* Navbar */
        .dashboard-nav { background: #fff; padding: 15px 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 100; }
        .brand { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 12px; }
        .nav-logo { height: 45px; }
        .nav-actions { display: flex; gap: 20px; align-items: center; }
        .profile-btn { text-decoration: none; color: #333; font-weight: 600; display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 6px 15px 6px 6px; border-radius: 30px; border: 1px solid #eee; transition: 0.3s; }
        .nav-profile-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold); }
        
        .container { max-width: 1350px; margin: 30px auto; padding: 0 20px; padding-bottom: 80px; }

        /* Hero */
        .welcome-hero { background: linear-gradient(135deg, #111, #333); border-radius: 15px; padding: 40px; color: white; text-align: center; margin-bottom: 40px; border-bottom: 5px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .welcome-hero h1 { font-family: 'Playfair Display', serif; font-size: 38px; margin: 0 0 10px 0; color: var(--gold); }
        
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.06); border-top: 1px solid #eee; height: 100%; box-sizing: border-box; }
        .card h3 { margin-top: 0; color: var(--dark-gold); font-family: 'Playfair Display', serif; font-size: 22px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }

        /* Calendar */
        .calendar-nav { display: flex; gap: 5px; }
        .btn-nav { background: #eee; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; margin-top: 15px; }
        .day-name { font-weight: 700; color: #888; font-size: 13px; padding-bottom: 10px; }
        .day { padding: 15px; background: #fdfdfd; border-radius: 8px; font-weight: 500; border: 1px solid #f0f0f0; cursor: pointer; position: relative; transition: 0.2s; }
        .day:hover { background: #fafafa; border-color: #ddd; }
        .day.weekend { background-color: #fff0f0; color: #c0392b; }
        .day.booked { background: #fff8e1; border-color: #ffe082; color: var(--dark-gold); font-weight: bold; }
        .day.multiple { background: #e3f2fd; border-color: #2196f3; color: #1565c0; font-weight: bold; }
        .day.today { background: #D4AF37 !important; color: white !important; font-weight: 800; border: 2px solid #aa8c2c; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); transform: scale(1.05); z-index: 5; }
        
        .event-dot { width: 6px; height: 6px; background: var(--gold); border-radius: 50%; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }
        .event-count { font-size: 10px; position: absolute; top: 2px; right: 5px; background: red; color: white; padding: 1px 4px; border-radius: 4px; }

        /* Upcoming List */
        .reminder-list { max-height: 400px; overflow-y: auto; }
        .reminder-item { display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; transition: 0.2s; border-radius: 8px; }
        .reminder-item:hover { background-color: #f9f9f9; transform: translateX(5px); cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .reminder-date { background: #f8f8f8; padding: 10px; border-radius: 8px; text-align: center; min-width: 50px; border: 1px solid #ddd; }
        .date-num { display: block; font-weight: 800; font-size: 18px; color: var(--gold); }

        /* Bottom Actions */
        .bottom-actions { display: flex; gap: 30px; margin-top: 50px; }
        .btn-big { flex: 1; padding: 22px; border: none; border-radius: 12px; font-weight: 700; font-size: 18px; cursor: pointer; transition: all 0.3s ease; text-align: center; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-tracker { background: #2c3e50; color: white; border-bottom: 5px solid #1a252f; }
        .btn-tracker:hover { background: #34495e; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(44, 62, 80, 0.3); }
        .btn-booking { background: var(--gold); color: white; border-bottom: 5px solid #aa8c2c; }
        .btn-booking:hover { background: #e0c055; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4); }

        /* --- ADDED THIS FOR THE NEW BUTTON --- */
        .btn-quick-menu { background: #27ae60; color: white; border-bottom: 5px solid #1e8449; }
        .btn-quick-menu:hover { background: #2ecc71; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: white; border-radius: 16px; width: 600px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); overflow: hidden; font-family: 'Segoe UI', sans-serif; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { background: linear-gradient(135deg, #D4AF37, #aa8c2c); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { color: white; font-family: 'Playfair Display', serif; font-size: 26px; margin: 0; font-weight: 700; letter-spacing: 0.5px; }
        .modal-close-btn { background: none; border: none; font-size: 28px; color: rgba(255,255,255,0.8); cursor: pointer; transition: 0.2s; line-height: 1; }
        .modal-close-btn:hover { color: white; transform: scale(1.1); }
        .modal-body { padding: 30px; }

        .event-select-list { display: flex; flex-direction: column; gap: 10px; }
        .event-select-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .event-select-item:hover { background: #f9f9f9; border-color: var(--gold); }
        .event-select-title { font-weight: bold; font-size: 16px; color: #333; }
        .event-select-meta { font-size: 13px; color: #777; }

        .event-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .detail-item { padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .detail-label { font-weight: 700; color: #aa8c2c; font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 4px; letter-spacing: 1px; }
        .detail-value { font-weight: 600; color: #2c3e50; font-size: 16px; }
        
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-confirmed { background: #e8f5e9; color: #27ae60; border: 1px solid #c8e6c9; }
        .status-pending { background: #fff8e1; color: #f39c12; border: 1px solid #ffe082; }
        .status-cancelled { background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }

        .detail-note { grid-column: 1 / -1; background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .detail-note .detail-value { font-size: 14px; color: #555; font-weight: normal; line-height: 1.5; }

        .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; padding-top: 20px; border-top: 1px solid #eee; }
        .action-row { display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-dl { font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; background: white; cursor: pointer; margin-left: 5px; }
        .btn-dl:hover { background: #f0f0f0; border-color: #999; }
        .btn-edit-menu { background: #fff3cd; border-color: #ffeeba; color: #856404; cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid #ffeeba; margin-left: 5px; }
        .btn-edit-menu:hover { background: #ffeeba; }

        /* --- RESPONSIVE DESIGN (MOBILE & TABLET) --- */
        @media (max-width: 900px) {
            .dashboard-nav { padding: 15px 20px; flex-direction: column; gap: 15px; }
            .nav-actions { width: 100%; justify-content: center; }
            .dash-grid { grid-template-columns: 1fr; } /* Stack columns vertically */
            .calendar-grid .day { padding: 10px; } /* Smaller calendar cells */
            .bottom-actions { flex-direction: column; gap: 15px; } /* Stack big buttons */
            .modal-content { width: 95%; } /* Modal takes mostly full width */
            .event-details-grid { grid-template-columns: 1fr; } /* Stack details in modal */
            .action-row { flex-direction: column; } /* Stack modal buttons */
        }
        @media (max-width: 1024px) {
            .container { margin: 15px auto; padding: 0 15px 100px 15px; }
            .dash-grid { grid-template-columns: 1fr; gap: 20px; }
            .welcome-hero { padding: 30px 20px; }
            .welcome-hero h1 { font-size: 28px; }
        }

        /* For Mobile Phones (below 768px) */
        @media (max-width: 768px) {
            /* Navbar tweaks */
            .dashboard-nav { 
                padding: 10px 15px; 
                flex-direction: row; /* Keep logo and profile side-by-side */
                justify-content: space-between; 
            }
            .brand { font-size: 20px; }
            .nav-logo { height: 35px; }
            .nav-actions { gap: 10px; }
            .profile-btn { padding: 4px 10px 4px 4px; font-size: 14px; }
            .nav-profile-img { width: 32px; height: 32px; }

            /* Calendar - Making text smaller so it fits */
            .calendar-grid { gap: 4px; }
            .day { 
                padding: 12px 2px; 
                font-size: 13px; 
                border-radius: 6px; 
            }
            .day-name { font-size: 11px; }
            .event-dot { width: 4px; height: 4px; bottom: 3px; }

            /* Big Bottom Buttons */
            .bottom-actions { 
                flex-direction: column; 
                gap: 12px; 
                margin-top: 30px; 
            }
            .btn-big { 
                padding: 16px; 
                font-size: 16px; 
            }

            /* Modal Adjustments */
            .modal-content { 
                width: 92%; 
                max-height: 90vh; 
                overflow-y: auto; 
            }
            .modal-header { padding: 15px 20px; }
            .modal-title { font-size: 20px; }
            .modal-body { padding: 20px; }
            
            .event-details-grid { 
                grid-template-columns: 1fr; /* Stack labels and values */
                gap: 15px; 
            }
            
            /* Tables inside Modals */
            .btn-dl, .btn-edit-menu {
                padding: 6px 10px;
                margin: 4px 2px;
                display: inline-block; /* Prevent overlapping buttons */
            }

            /* Stack Admin Action Buttons */
            .action-row { 
                flex-direction: column; 
                gap: 8px; 
            }
            .btn-modal { width: 100%; }
        }

        /* Extra Small Screens (Small phones) */
        @media (max-width: 480px) {
            .day { padding: 8px 1px; font-size: 12px; }
            .welcome-hero h1 { font-size: 22px; }
            .brand span { display: none; } /* Hide text, keep logo if too small */
        }
    </style>
</head>
<body>

    <nav class="dashboard-nav">
        <div class="brand">
            <img src="{% static 'images/logo/logo.png' %}" class="nav-logo" alt="Logo"> Swagat Caterers
        </div>
        <div class="nav-actions">
            <a href="{% url 'profile' %}" class="profile-btn">
                <img src="{% static 'images/default_user.png' %}" id="nav-img" class="nav-profile-img">
                <span id="nav-username">Profile</span>
            </a>
            <button
                onclick="logoutUser()"
                style="color:red; border:1px solid red; background:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-weight:600;">
                Logout
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-hero">
            <h1 id="welcome-msg">Welcome</h1>
            <p>Admin Dashboard</p>
        </div>

        <div class="dash-grid">
            <div class="card">
                <h3>
                    <span id="cal-month-year">Calendar</span>
                    <div class="calendar-nav">
                        <button class="btn-nav" onclick="changeMonth(-1)">&#8249;</button>
                        <button class="btn-nav" onclick="changeMonth(1)">&#8250;</button>
                    </div>
                </h3>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <div class="card">
                <h3>Upcoming Events (30 Days)</h3>
                <div class="reminder-list" id="reminder-container" style="min-height: 150px;">Loading...</div>
            </div>
        </div>

        <div class="bottom-actions">
            <a href="{% url 'tracker' %}" class="btn-big btn-tracker">
                üìä Daily Member Tracker & Accounts
            </a>
            <a href="{% url 'booking' %}" class="btn-big btn-booking">
                + Add New Booking
            </a>
            <a href="{% url 'direct_menu' %}" class="btn-big btn-quick-menu">
                üçΩÔ∏è Create Menu Directly
            </a>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Event Details</h3>
                <button class="modal-close-btn" onclick="document.getElementById('eventModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <div id="multi-event-list" style="display:none;" class="event-select-list"></div>
                <div id="event-details-content"></div>
                <div id="admin-menu-actions" class="modal-actions" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        const CREATE_MENU_URL = "{% url 'create_menu' %}";
        const PRINT_BILL_URL = "{% url 'print_bill' %}";
        const BOOKING_URL = "/dashboard/booking/";
       
        let currentDate = new Date();
        let allEvents = [];
        let isSuperUser = false;
        let allItems = [];
        let categories = [];

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- HELPER: DATE FORMATTER (DD-MM-YYYY) ---
        function formatDateDisplay(yyyy_mm_dd) {
            if (!yyyy_mm_dd) return "-";
            try {
                const p = yyyy_mm_dd.split('-');
                if(p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`; // Convert 2026-01-23 -> 23-01-2026
            } catch(e) { return yyyy_mm_dd; }
            return yyyy_mm_dd;
        }

        async function init() {
            // 1. You MUST grab the fresh token from storage INSIDE init
            const token = localStorage.getItem('authToken'); 

            if (!token) {
                window.location.href = "/login/";
                return;
            }

            try {
                // 2. Use that fresh token for the user verification call
                const uRes = await fetch('/auth/users/me/', { 
                    headers: { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken')} 
                });

                if (!uRes.ok) {
                    // If Railway/Django rejects the token, clear it and go back to login
                    console.error("Token invalid or session expired");
                    localStorage.removeItem('authToken');
                    window.location.href = "/login/";
                    return;
                }

                const user = await uRes.json();
                isSuperUser = user.is_staff || user.is_superuser;
                
                // Update UI
                const welcomeEl = document.getElementById('welcome-msg');
                if (welcomeEl) welcomeEl.innerText = `Welcome, ${user.username}`;
                
                const navImg = document.getElementById('nav-img');
                if(user.profile_image && navImg) navImg.src = user.profile_image;

                // 3. Fetch all other data using the same token
                const headers = { 'Authorization': `Token ${token}` , 'X-CSRFToken': getCookie('csrftoken')};
                const [cRes, iRes, eRes] = await Promise.all([
                    fetch('/api/menu/categories/', { headers }),
                    fetch('/api/menu/menu-items/', { headers }),
                    fetch('/api/menu/events/', { headers })
                ]);

                allEvents = await eRes.json();
                categories = await cRes.json();
                allItems = await iRes.json();

                // Hide admin buttons if necessary
                if (!isSuperUser) {
                    document.querySelector('.btn-booking')?.style.setProperty('display', 'none');
                    document.querySelector('.btn-quick-menu')?.style.setProperty('display', 'none');
                }

                renderCalendar(currentDate);
                renderUpcoming();

            } catch(e) { 
                console.error("Dashboard Load Error:", e);
            }
        }

        // --- CALENDAR ---
        function renderCalendar(date) {
            const year = date.getFullYear(), month = date.getMonth();
            const first = new Date(year, month, 1).getDay(), days = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            document.getElementById('cal-month-year').innerText = date.toLocaleString('default', { month: 'long', year: 'numeric' });
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '<div class="day-name" style="color:#c0392b">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div><div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name" style="color:#c0392b">Sat</div>';
            for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
            for(let i=1; i<=days; i++) {
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const eventsOnDay = allEvents.filter(e => e.date === dStr);
                const count = eventsOnDay.length;
                const dayObj = new Date(year, month, i);
                const isToday = (today.getDate()===i && today.getMonth()===month && today.getFullYear()===year);
                let cls = 'day' + (dayObj.getDay()===0||dayObj.getDay()===6 ? ' weekend' : '');
                if (count === 1) cls += ' booked';
                if (count > 1) cls += ' multiple';
                if (isToday) cls += ' today';
                let indicators = '';
                if(count > 0) indicators = `<div class="event-dot"></div>`;
                if(count > 1) indicators = `<span class="event-count">${count}</span>`;
                grid.innerHTML += `<div class="${cls}" onclick="handleDateClick('${dStr}')">${i} ${indicators}</div>`;
            }
        }

        // --- UPCOMING EVENTS ---
        function renderUpcoming() {
            const today = new Date();
            const next = new Date(); next.setDate(today.getDate() + 30);
            const list = allEvents.filter(e => { const d = new Date(e.date); return d >= today && d <= next; });
            const container = document.getElementById('reminder-container');
            container.innerHTML = list.length ? '' : '<p style="color:#999; text-align:center;">No upcoming events.</p>';
            
            list.forEach(e => {
                container.innerHTML += `
                    <div class="reminder-item" onclick="handleDateClick(null, ${e.id})">
                        <div class="reminder-date"><span class="date-num">${new Date(e.date).getDate()}</span></div>
                        <div>
                            <strong>${e.title}</strong><br>
                            <small>${formatDateDisplay(e.date)} | ${e.guests} Guests</small>
                        </div>
                    </div>`;
            });
        }

        function handleDateClick(dateStr, eventId) {
            const modalContent = document.getElementById('event-details-content');
            const adminActions = document.getElementById('admin-menu-actions');
            const listContainer = document.getElementById('multi-event-list');
            
            // Clear and hide everything first
            listContainer.style.display = 'none';
            modalContent.style.display = 'none';
            adminActions.style.display = 'none';

            let eventToOpen = null;

            if (eventId) {
                // Came from "Upcoming Events" list
                eventToOpen = allEvents.find(e => e.id == eventId);
            } else if (dateStr) {
                // Came from Calendar click
                const eventsOnDay = allEvents.filter(e => e.date === dateStr);
                
                if (eventsOnDay.length === 0) {
                    // CASE 1: No data exists for this day
                    renderNoEvent(dateStr); 
                    return; 
                } else if (eventsOnDay.length === 1) {
                    // CASE 2: Exactly one event found
                    eventToOpen = eventsOnDay[0]; 
                } else {
                    // CASE 3: Multiple events found (e.g., 2 weddings on same day)
                    renderEventList(eventsOnDay); 
                    return; 
                }
            }

            if (eventToOpen) { 
                renderEventDetails(eventToOpen); 
            }
        }

        function renderNoEvent(dateStr) {
            const modalContent = document.getElementById('event-details-content');
            document.getElementById('modal-title').innerText = "Date Info";
            modalContent.style.display = 'block';

            let html = `<div style="text-align:center; padding:20px;"><p>No events on ${formatDateDisplay(dateStr)}.</p></div>`;

            if (isSuperUser) {
                html += `
                    <div style="text-align:center;">
                        <button onclick="window.location.href='/booking/?date=${dateStr}'" 
                                style="padding:10px 20px; background:#2c3e50; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                            + Add Booking
                        </button>
                    </div>`;
            }
            modalContent.innerHTML = html;
            document.getElementById('eventModal').style.display = 'flex';
        }

        function renderEventList(events) {
            const listContainer = document.getElementById('multi-event-list');
            document.getElementById('modal-title').innerText = `Select Event (${events.length})`;
            listContainer.style.display = 'flex';
            let html = '';
            events.forEach(e => {
                html += `<div class="event-select-item" onclick="handleDateClick(null, ${e.id})"><div><div class="event-select-title">${e.title}</div><div class="event-select-meta">${formatDateDisplay(e.date)} | ${e.guests} Guests</div></div><div style="font-size:20px; color:#aaa;">‚Ä∫</div></div>`;
            });
            listContainer.innerHTML = html;
            document.getElementById('eventModal').style.display = 'flex';
        }

        function renderEventDetails(event) {
            const modalContent = document.getElementById('event-details-content');
            const adminActions = document.getElementById('admin-menu-actions');
            modalContent.style.display = 'block';
            document.getElementById('modal-title').innerText = event.title;

            let contactInfo = event.contact_number || "N/A";
            let alternateInfo = ""; 
            if (event.description && event.description.includes("Contact:")) {
                contactInfo = event.description.split("Contact:")[1].split("Note:")[0].trim();
            }
            if (event.contact_number && contactInfo !== event.contact_number) {
                alternateInfo = `<div style="font-size:13px; color:#666; margin-top:3px;">Alt: ${event.contact_number}</div>`;
            }
            let noteInfo = event.description ? event.description : "No notes.";

            let menuListHtml = '<p style="color:#999; font-style:italic; font-size:13px; margin:0;">No menus created yet.</p>';
            if (event.menus && event.menus.length > 0) {
                menuListHtml = `<table style="width:100%; font-size:13px; border-collapse:collapse; margin-top:5px;"><tr style="background:#f9f9f9; text-align:left; color:#666;"><th style="padding:6px; border-bottom:1px solid #eee;">Menu</th><th style="padding:6px; border-bottom:1px solid #eee; text-align:right;">Actions</th></tr>`;
                
                event.menus.forEach(m => {
                    let priceDisplay = isSuperUser ? `<br><span style='font-size:11px; color:green;'>‚Çπ${m.price_per_plate}</span>` : "";
                    
                    // --- ADMIN: EDIT BUTTON & DOWNLOAD BUTTONS ---
                    // --- USER: VIEW ONLY ---
                    let actionsHtml = "";
                    
                    if (isSuperUser) {
                        let editBtn = `
                        <button class="btn-dl btn-edit-menu"
                            onclick="window.location.href=
                            \`${CREATE_MENU_URL}?event_id=${event.id}&menu_id=${m.id}\`"
                            title="Edit Menu">
                            ‚úèÔ∏è
                        </button>`;
                        actionsHtml = `
                            <button class="btn-dl" onclick="downloadMenuPDF(${m.id}, 'en', '${event.title.replace(/'/g, "\\'")}', '${event.date}', '${event.guests}', '${event.venue || 'N/A'}', '${event.contact_number || ''}', false)">‚¨á ENG</button>
                            <button class="btn-dl" onclick="downloadMenuPDF(${m.id}, 'gu', '${event.title.replace(/'/g, "\\'")}', '${event.date}', '${event.guests}', '${event.venue || 'N/A'}', '${event.contact_number || ''}', false)">‚¨á GUJ</button>
                            ${editBtn}
                        `;
                    } else {
                        actionsHtml = `
                            <button class="btn-dl" style="background:#e3f2fd; border-color:#2196f3; color:#1565c0;" onclick="downloadMenuPDF(${m.id}, 'en', '${event.title.replace(/'/g, "\\'")}', '${event.date}', '${event.guests}', '${event.venue || 'N/A'}', '${event.contact_number || ''}', true)">üëÅ View ENG</button>
                            <button class="btn-dl" style="background:#e3f2fd; border-color:#2196f3; color:#1565c0;" onclick="downloadMenuPDF(${m.id}, 'gu', '${event.title.replace(/'/g, "\\'")}', '${event.date}', '${event.guests}', '${event.venue || 'N/A'}', '${event.contact_number || ''}', true)">üëÅ View GUJ</button>
                        `;
                    }

                    menuListHtml += `<tr><td style="padding:6px; border-bottom:1px solid #eee;"><strong>${m.title}</strong>${priceDisplay}</td><td style="padding:6px; border-bottom:1px solid #eee; text-align:right;">${actionsHtml}</td></tr>`;
                });
                menuListHtml += `</table>`;
            }

            modalContent.innerHTML = `<div class="event-details-grid"><div class="detail-item"><span class="detail-label">Date</span><span class="detail-value">${formatDateDisplay(event.date)}</span></div><div class="detail-item"><span class="detail-label">Venue</span><span class="detail-value">${event.venue || 'N/A'}</span></div><div class="detail-item"><span class="detail-label">Type</span><span class="detail-value">${event.event_type || 'General'}</span></div><div class="detail-item"><span class="detail-label">Guests</span><span class="detail-value">${event.guests}</span></div><div class="detail-item"><span class="detail-label">Status</span><span class="status-badge status-${event.status}">${event.status.toUpperCase()}</span></div><div class="detail-item"><span class="detail-label">Contact Info</span><span class="detail-value" style="font-family:monospace; font-size:16px;">${contactInfo}</span>${alternateInfo}</div><div class="detail-item" style="grid-column: 1 / -1; background:#fffcf5; padding:10px; border:1px solid #ffe082; border-radius:6px;"><span class="detail-label" style="color:#b59020;">Menus & Downloads</span><div style="margin-top:5px;">${menuListHtml}</div></div><div class="detail-item detail-note"><span class="detail-label">Notes</span><span class="detail-value">${noteInfo}</span></div></div>`;

            if (isSuperUser) {
                adminActions.style.display = 'flex';
                adminActions.innerHTML = `
                        <div class="action-row">
                            <button class="btn-modal"
                                onclick="window.location.href=\`${CREATE_MENU_URL}?event_id=${event.id}\`"
                                style="background:#2c3e50; color:white;">
                                üçΩÔ∏è Manage Menu
                            </button>

                            <button class="btn-modal"
                                onclick="window.location.href=\`${PRINT_BILL_URL}?event_id=${event.id}\`"
                                style="background:var(--gold); color:white;">
                                üßæ Print Bill
                            </button>
                        </div>

                        <div class="action-row">
                            <button class="btn-modal"
                                onclick="window.location.href='${BOOKING_URL}?event_id=${event.id}'"
                                style="background:#f0f0f0; color:#333; border:1px solid #ccc;">
                                ‚úèÔ∏è Edit Details
                            </button>

                            <button class="btn-modal"
                                onclick="deleteEvent(${event.id})"
                                style="background:#ffebee; color:#c0392b; border:1px solid #ffcdd2;">
                                üóëÔ∏è Delete Event
                            </button>
                        </div>
                        `;            }
            document.getElementById('eventModal').style.display = 'flex';
        }

        async function deleteEvent(id) {
            if (!confirm("‚ö†Ô∏è Are you sure you want to PERMANENTLY DELETE this booking?")) return;
            try {
                // Ensure this line looks exactly like this:
                const res = await fetch(`/api/menu/events/${id}/`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Token ${token}` ,'X-CSRFToken': getCookie('csrftoken') } 
                });
                
                if (res.ok) { 
                    alert("‚úÖ Booking deleted successfully."); 
                    location.reload(); 
                } else { 
                    alert("Failed to delete booking."); 
                }
            } catch (e) { 
                alert("Network Error: Could not connect to server."); 
            }
        }

        function changeMonth(s) { currentDate.setMonth(currentDate.getMonth()+s); renderCalendar(currentDate); }

        // --- UPDATED PDF GENERATOR FOR DASHBOARD ---
        async function downloadMenuPDF(menuId, lang, eventTitle, eventDate, eventGuests, eventVenue, eventContact, isPreview) {
            try {
                // --- ADDED THIS LINE TO FIX THE ERROR ---
                const token = localStorage.getItem('access_token'); // Or 'auth_token' depending on your login storage key

                if (!token) {
                    alert("Authentication session expired. Please log in again.");
                    return;
                }

                const res = await fetch(`/api/menu/menus/${menuId}/`, { 
                    headers: { 
                        'Authorization': `Token ${token}`, 
                        'X-CSRFToken': getCookie('csrftoken') 
                    } 
                });
                
                if(!res.ok) throw new Error("Could not fetch menu items");
                const menu = await res.json();
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // --- LOAD ASSETS ---
                let fontBase64 = null, bgBase64 = null, coverBase64 = null, backBase64 = null;
                async function loadImage(url) {
                    try {
                        const r = await fetch(url);
                        if (r.ok) {
                            const b = await r.blob();
                            return new Promise(res => {
                                const read = new FileReader();
                                read.onloadend = () => res(read.result);
                                read.readAsDataURL(b);
                            });
                        }
                    } catch (e) { console.warn("Fetch failed for: " + url); }
                    return null;
                }

                try {
                    [bgBase64, coverBase64, backBase64] = await Promise.all([
                        loadImage('{% static "images/background.png" %}'),
                        loadImage('{% static "images/cover.png" %}'),
                        loadImage('{% static "images/last.png" %}')
                    ]);

                    if (lang === 'gu') {
                        const response = await fetch("{% static 'Gujarati.ttf' %}");
                        if (!response.ok) throw new Error("Missing Gujarati.ttf");
                        const blob = await response.blob();
                        const reader = new FileReader();
                        await new Promise(resolve => { reader.onloadend = () => resolve(reader.result); reader.readAsDataURL(blob); });
                        fontBase64 = reader.result.split(',')[1];
                        doc.addFileToVFS('Gujarati.ttf', fontBase64);
                        doc.addFont('Gujarati.ttf', 'Gujarati', 'normal');
                        doc.setFont('Gujarati');
                    } else { doc.setFont("helvetica", "normal"); }
                } catch (e) { alert("Asset Loading Error: " + e.message); return; }

                // --- 1. COVER PAGE ---
                if (coverBase64) {
                    doc.addImage(coverBase64, 'PNG', 0, 0, 210, 297);
                    
                    const formattedDate = formatDateDisplay(eventDate);
                    const combinedText = `${eventTitle || ""} - ${formattedDate}`;
                    
                    doc.setTextColor(212, 175, 55); 
                    doc.setFont("times", "bold"); 
                    doc.setFontSize(20); 
                    doc.text(combinedText, 105, 200, { align: 'center' }); 

                    if(lang === 'gu') doc.setFont('Gujarati'); else doc.setFont("helvetica", "normal");
                    doc.addPage();
                }

                // --- HELPER: DRAW LAYOUT ---
                function drawLayoutAndGrid() {
                    if(bgBase64) doc.addImage(bgBase64, 'PNG', 0, 0, 210, 297);
                    
                    const startY = 43; 
                    const rowHeight = 6; 
                    
                    doc.setDrawColor(212, 175, 55); 
                    doc.setLineWidth(0.5);
                    doc.line(15, startY, 195, startY);

                    if(lang !== 'gu') doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    
                    // Row 1
                    const row1Y = startY + 5;
                    doc.setTextColor(212, 175, 55); doc.text("Name :", 20, row1Y);
                    doc.setTextColor(0, 0, 0);      doc.text(eventTitle || "-", 35, row1Y);
                    
                    doc.setTextColor(212, 175, 55); doc.text("Dish :", 90, row1Y);
                    doc.setTextColor(0, 0, 0);      doc.text(String(eventGuests || "-"), 105, row1Y);

                    doc.setTextColor(212, 175, 55); doc.text("Rate :", 150, row1Y);
                    
                    // --- RATE HIDDEN FOR NON-ADMIN ---
                    let priceDisplay = isSuperUser ? (menu.price_per_plate || "0") : "**";
                    doc.setTextColor(0, 0, 0);      doc.text(String(priceDisplay), 165, row1Y);

                    // Row 2
                    const row2Y = row1Y + rowHeight;
                    doc.setTextColor(212, 175, 55); doc.text("Date :", 20, row2Y);
                    doc.setTextColor(0, 0, 0);      doc.text(formatDateDisplay(eventDate), 35, row2Y);
                    
                    doc.setTextColor(212, 175, 55); doc.text("Contact :", 90, row2Y);
                    doc.setTextColor(0, 0, 0);      doc.text(eventContact || "-", 112, row2Y);

                    doc.setTextColor(212, 175, 55); doc.text("Event :", 150, row2Y);
                    doc.setTextColor(0, 0, 0);      doc.text(menu.title || "-", 165, row2Y);

                    // Row 3
                    const row3Y = row2Y + rowHeight;
                    doc.setTextColor(212, 175, 55); doc.text("Venue :", 20, row3Y);
                    doc.setTextColor(0, 0, 0);      doc.text(eventVenue || "-", 35, row3Y);

                    const endY = row3Y + 3; 
                    doc.setDrawColor(212, 175, 55); 
                    doc.line(15, endY, 195, endY);

                    if(lang !== 'gu') doc.setFont("helvetica", "normal"); 
                    return endY + 12; 
                }

                function drawHeader(text, x, y) {
                    doc.setFillColor(198, 153, 79); 
                    doc.roundedRect(x, y - 6, 80, 8, 3, 3, 'F');
                    doc.setTextColor(0,0,0); 
                    doc.setFontSize(11);
                    if(lang !== 'gu') doc.setFont("helvetica", "bold");
                    doc.text(text, x + 5, y - 1);
                    if(lang !== 'gu') doc.setFont("helvetica", "normal");
                }

                // --- CONTENT GENERATION ---
                let startContentY = drawLayoutAndGrid();
                let xLeft = 15;
                let xRight = 110;
                let currentX = xLeft;
                let currentY = startContentY;
                let maxY = 275; 
                let itemLineHeight = 6;
                let headerHeight = 10;

                function checkPageBreak(heightNeeded) {
                    if (currentY + heightNeeded > maxY) {
                        if (currentX === xLeft) { 
                            currentX = xRight; 
                            currentY = startContentY; 
                        } else { 
                            doc.addPage();
                            let newStartY = drawLayoutAndGrid(); 
                            currentX = xLeft; 
                            currentY = newStartY; 
                        }
                    }
                }

                const menuItems = allItems.filter(i => menu.items.includes(i.id));

                for (let i = 0; i < categories.length; i++) {
                    const cat = categories[i];
                    const itemsInCat = menuItems.filter(item => item.category == cat.id);

                    if (itemsInCat.length === 0) continue;

                    const blockHeight = headerHeight + (itemsInCat.length * itemLineHeight) + 5;
                    checkPageBreak(blockHeight);

                    let catName = (lang==='gu' && cat.gujarati_name) ? cat.gujarati_name : cat.name;
                    drawHeader(catName, currentX, currentY);
                    currentY += headerHeight;

                    doc.setTextColor(0,0,0); doc.setFontSize(10);
                    itemsInCat.forEach(item => {
                        let itemName = (lang==='gu' && item.gujarati_name) ? item.gujarati_name : item.name;
                        doc.text(itemName, currentX + 5, currentY);
                        currentY += itemLineHeight;
                    });
                    currentY += 5;
                }

                // 4. FOOTER NOTE
                const noteText = menu.note; 
                if (noteText) {
                    const noteHeader = lang === 'gu' ? '‡™µ‡™ø‡™∂‡´á‡™∑ ‡™®‡´ã‡™Ç‡™ß' : 'SPECIAL NOTE';
                    const noteLines = doc.splitTextToSize(noteText, 170); 
                    
                    const headerH = 8;
                    const padding = 6;
                    const textBlockH = (noteLines.length * 6);
                    const boxHeight = headerH + textBlockH + padding;
                    
                    const pageHeight = 297; 
                    const bottomMargin = 15; 
                    let footerY = pageHeight - bottomMargin - boxHeight;

                    if (currentY > footerY) {
                        doc.addPage();
                        drawLayoutAndGrid(); 
                        footerY = pageHeight - bottomMargin - boxHeight;
                    }

                    doc.setFillColor(255, 252, 245); doc.setDrawColor(198, 153, 79); doc.setLineWidth(0.5);
                    doc.roundedRect(15, footerY, 180, boxHeight, 3, 3, 'FD');
                    doc.setFillColor(198, 153, 79); 
                    doc.roundedRect(15, footerY, 180, headerH, 2, 2, 'F');
                    doc.rect(15, footerY + headerH - 2, 180, 2, 'F'); 

                    doc.setTextColor(255,255,255); doc.setFontSize(11);
                    if(lang !== 'gu') doc.setFont("helvetica", "bold");
                    doc.text(noteHeader, 105, footerY + 5.5, { align: 'center' }); 

                    doc.setTextColor(0,0,0); doc.setFontSize(10);
                    if(lang !== 'gu') doc.setFont("helvetica", "normal");
                    doc.text(noteLines, 20, footerY + headerH + 6); 
                }

                // --- 2. BACK COVER ---
                if (backBase64) {
                    doc.addPage();
                    doc.addImage(backBase64, 'PNG', 0, 0, 210, 297);
                }

                // --- SAVE OR PREVIEW ---
                if (isPreview) {
                    window.open(doc.output('bloburl'), '_blank');
                } else {
                    const safeTitle = eventTitle.replace(/[^a-zA-Z0-9 ]/g, "").trim();
                    const filenameDate = formatDateDisplay(eventDate).replace(/\//g, "-").slice(0,5); 
                    doc.save(`${safeTitle} - ${filenameDate} - SwagatCaterers.pdf`);
                }
                
            } catch(e) { console.error(e); alert("Error generating PDF"); }
        }

        init();
    </script>
    <script>
    function logoutUser() {
        localStorage.clear();
        window.location.href = "{% url 'login' %}";
    }
</script>
</body>
</html>