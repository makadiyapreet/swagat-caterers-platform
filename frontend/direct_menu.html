<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Menu Creator - Swagat Caterers</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Segoe+UI:wght@400;500;600&family=Noto+Sans+Gujarati:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --gold: #D4AF37; --dark-gold: #aa8c2c; --bg: #f8f9fa; --text: #2c3e50; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--text); padding-bottom: 100px; }
        
        /* Font helper for Gujarati */
        .font-guj { font-family: 'Noto Sans Gujarati', sans-serif; }

        /* Navbar */
        .dashboard-nav { background: #fff; padding: 15px 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 100; }
        .brand { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .nav-logo { height: 40px; }
        .back-btn { background: #eee; color: #333; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; transition: 0.2s; white-space: nowrap; }
        .back-btn:hover { background: #ddd; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Header Section */
        .page-header { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border-left: 5px solid var(--gold); display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
        .header-title h1 { margin: 0; font-family: 'Playfair Display', serif; color: var(--dark-gold); font-size: 28px; }
        .header-title p { margin: 5px 0 0; color: #666; font-size: 14px; }
        
        /* Client Inputs */
        .client-inputs { display: flex; gap: 15px; flex-wrap: wrap; width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .input-group input:focus { border-color: var(--gold); outline: none; }

        /* Content Grid */
        .builder-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }

        /* Menu Accordion */
        .category-card { background: white; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid #f0f0f0; }
        .cat-header { padding: 15px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 16px; transition: 0.2s; }
        .cat-header:hover { background: #fdfdfd; color: var(--dark-gold); }
        .cat-header.active { background: #fffcf5; color: var(--gold); border-bottom: 1px solid #eee; }
        .cat-body { padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fafafa; }
        .cat-body.open { padding: 20px; max-height: 2000px; border-top: 1px solid #f0f0f0; }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .item-check { display: flex; align-items: flex-start; gap: 10px; padding: 10px; background: white; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: 0.2s; min-height: 40px; }
        .item-check:hover { border-color: #ddd; }
        .item-check input { margin-top: 4px; transform: scale(1.2); cursor: pointer; accent-color: var(--gold); flex-shrink: 0; }
        .item-label { font-size: 14px; color: #333; user-select: none; flex: 1; line-height: 1.4; }

        .custom-area { margin-top: 15px; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box; }

        /* Sidebar / Summary */
        .summary-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: sticky; top: 100px; border-top: 4px solid var(--gold); }
        .summary-card h3 { margin-top: 0; font-family: 'Playfair Display', serif; color: #333; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Language Switcher */
        .lang-switch { display: flex; margin-bottom: 20px; background: #f0f0f0; padding: 4px; border-radius: 8px; }
        .lang-opt { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 600; color: #666; transition: 0.3s; }
        .lang-opt.active { background: white; color: var(--dark-gold); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .summary-stats { margin: 15px 0; font-size: 14px; color: #555; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-val { font-weight: 700; color: var(--dark-gold); }

        .btn-action { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; margin-bottom: 10px; transition: 0.2s; text-align: center; gap: 8px; }
        .btn-pdf { background: #2c3e50; color: white; }
        .btn-pdf:hover { background: #34495e; }
        .btn-save { background: var(--gold); color: white; }
        .btn-save:hover { background: #e0c055; }
        .btn-preview { background: white; border: 1px solid #ccc; color: #666; }
        .btn-preview:hover { background: #f9f9f9; color: #333; }

        /* Responsive */
        @media (max-width: 900px) {
            .builder-grid { grid-template-columns: 1fr; }
            .summary-card { position: relative; top: 0; z-index: 10; margin-bottom: 30px; }
            .client-inputs { flex-direction: column; gap: 10px; }
            .page-header { flex-direction: column; align-items: stretch; }
            .nav-logo { height: 35px; }
            .brand { font-size: 20px; }
            .dashboard-nav { padding: 15px 20px; }
        }
    </style>
</head>
<body>

    <nav class="dashboard-nav">
        <a href="dashboard.html" class="brand">
            <img src="images/logo/logo.png" class="nav-logo" alt="Logo"> Swagat Admin
        </a>
        <a href="dashboard.html" class="back-btn">‚Üê Dashboard</a>
    </nav>

    <div class="container">
        <div class="page-header">
            <div class="header-title" style="flex: 1;">
                <h1 id="page-title">Direct Menu</h1>
                <p id="page-subtitle">Select items to generate a PDF instantly.</p>
            </div>
            
            <div class="client-inputs" id="standalone-inputs" style="display:none;">
                <div class="input-group">
                    <label>Client Name</label>
                    <input type="text" id="client-name" placeholder="Enter Name">
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="event-date">
                </div>
                <div class="input-group">
                    <label>Guests</label>
                    <input type="number" id="guest-count" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Venue</label>
                    <input type="text" id="venue-name" placeholder="Optional">
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="text" id="client-phone" placeholder="Optional">
                </div>
            </div>

            <div class="client-inputs" id="linked-inputs" style="display:none; background: #fffcf5; border: 1px solid #ffe082; padding: 15px; border-radius: 8px;">
                <div style="font-size: 15px; color: #555; width: 100%;">
                    <strong style="color:#aa8c2c">Booking:</strong> <span id="linked-name" style="font-weight:bold; color:#000;">-</span> | 
                    <span id="linked-date">-</span> | <span id="linked-guests">-</span> Guests
                </div>
            </div>
        </div>

        <div class="builder-grid">
            <div id="menu-accordion">
                <div style="text-align:center; padding: 40px; color: #999;">Loading Menu Items...</div>
            </div>

            <div class="summary-wrapper">
                <div class="summary-card">
                    <h3>Menu Controls</h3>
                    
                    <label style="font-size:12px; font-weight:bold; color:#888; display:block; margin-bottom:5px;">VIEW LANGUAGE:</label>
                    <div class="lang-switch">
                        <div class="lang-opt active" id="lang-en" onclick="switchViewLang('en')">English</div>
                        <div class="lang-opt font-guj" id="lang-gu" onclick="switchViewLang('gu')">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</div>
                    </div>

                    <div class="summary-stats">
                        <div class="stat-row"><span>Categories:</span> <span class="stat-val" id="count-cats">0</span></div>
                        <div class="stat-row"><span>Items:</span> <span class="stat-val" id="count-items">0</span></div>
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label>Footer Note</label>
                        <textarea id="menu-note" class="custom-area" rows="3" placeholder="Ex: Jain Food, Spicy..."></textarea>
                    </div>

                    <button class="btn-action btn-pdf" onclick="generatePDF('en', false)">
                        ‚¨á Download English PDF
                    </button>
                    <button class="btn-action btn-pdf" onclick="generatePDF('gu', false)" style="background:#856404;">
                        ‚¨á Download Gujarati PDF
                    </button>

                    <div style="display:flex; gap:10px;">
                        <button class="btn-action btn-preview" onclick="generatePDF('en', true)">üëÅ Eng</button>
                        <button class="btn-action btn-preview" onclick="generatePDF('gu', true)">üëÅ Guj</button>
                    </div>

                    <button id="btn-save-db" class="btn-action btn-save" style="display:none; margin-top:10px;" onclick="saveToDatabase()">
                        üíæ Save to Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP & AUTH ---
        const token = localStorage.getItem('authToken');
        if (!token) window.location.href = "login.html";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event_id');
        const menuId = urlParams.get('menu_id');

        // State
        let categories = [];
        let allItems = [];
        let selectedItems = new Set(); 
        let currentEventData = null;
        let viewLang = 'en'; // Controls what language is shown on screen

        async function init() {
            try {
                // 1. Verify Admin Status First
                const userRes = await fetch('http://127.0.0.1:8000/auth/users/me/', { 
                    headers: { 'Authorization': `Token ${token}` } 
                });
                
                if (!userRes.ok) throw new Error("Auth failed");
                
                const user = await userRes.json();
                
                // RESTRICT ACCESS: Only Staff/Superusers can see this page
                if (!user.is_staff && !user.is_superuser) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Access Denied',
                        text: 'Only Admins can access the Direct Menu Creator.',
                        confirmButtonText: 'Go to Dashboard',
                        confirmButtonColor: '#d4af37',
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.href = 'dashboard.html';
                    });
                    return; // Stop execution
                }

                // 2. Load Data if Admin
                const [catRes, itemRes] = await Promise.all([
                    fetch('http://127.0.0.1:8000/api/menu/categories/', { headers: { 'Authorization': `Token ${token}` } }),
                    fetch('http://127.0.0.1:8000/api/menu/menu-items/', { headers: { 'Authorization': `Token ${token}` } })
                ]);
                categories = await catRes.json();
                allItems = await itemRes.json();

                renderAccordion();

                if (eventId) {
                    setupLinkedMode();
                } else {
                    setupStandaloneMode();
                }
            } catch (e) { 
                console.error(e); 
                Swal.fire("Error", "Failed to load data.", "error"); 
            }
        }

        // --- 2. MODES ---
        async function setupLinkedMode() {
            document.getElementById('linked-inputs').style.display = 'flex';
            document.getElementById('btn-save-db').style.display = 'flex'; 
            
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/menu/events/${eventId}/`, { headers: { 'Authorization': `Token ${token}` } });
                currentEventData = await res.json();
                
                document.getElementById('linked-name').innerText = currentEventData.title;
                document.getElementById('linked-date').innerText = currentEventData.date;
                document.getElementById('linked-guests').innerText = currentEventData.guests;
                document.getElementById('page-title').innerText = "Manage Menu";
                document.getElementById('page-subtitle').innerText = `Editing menu for: ${currentEventData.title}`;

                if (menuId) { loadExistingMenu(menuId); }
            } catch(e) { console.error(e); }
        }

        function setupStandaloneMode() {
            document.getElementById('standalone-inputs').style.display = 'flex';
            document.getElementById('event-date').valueAsDate = new Date();
        }

        async function loadExistingMenu(mid) {
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/menu/menus/${mid}/`, { headers: { 'Authorization': `Token ${token}` } });
                const menu = await res.json();
                
                menu.items.forEach(id => {
                    selectedItems.add(parseInt(id));
                });
                
                if(menu.note) document.getElementById('menu-note').value = menu.note;
                
                // Re-render to show checks
                renderAccordion();
                
                // Open relevant categories
                categories.forEach(cat => {
                    const hasSel = menu.items.some(iId => allItems.find(x => x.id === iId)?.category === cat.id);
                    if(hasSel) toggleCategory(cat.id, true);
                });
                updateStats();
            } catch(e) { console.error(e); }
        }

        // --- 3. RENDERING & UI ---
        function switchViewLang(lang) {
            viewLang = lang;
            document.getElementById('lang-en').className = `lang-opt ${lang === 'en' ? 'active' : ''}`;
            document.getElementById('lang-gu').className = `lang-opt font-guj ${lang === 'gu' ? 'active' : ''}`;
            renderAccordion(); // Re-render text
        }

        function renderAccordion() {
            const container = document.getElementById('menu-accordion');
            // Store currently open categories to restore state
            const openCats = Array.from(document.querySelectorAll('.cat-body.open')).map(el => el.id);
            
            container.innerHTML = '';

            categories.forEach(cat => {
                const catItems = allItems.filter(i => i.category === cat.id);
                if (catItems.length === 0) return;

                // Determine Display Names
                const catName = (viewLang === 'gu' && cat.gujarati_name) ? cat.gujarati_name : cat.name;

                let itemsHtml = '';
                catItems.forEach(item => {
                    const isChecked = selectedItems.has(item.id) ? 'checked' : '';
                    const itemName = (viewLang === 'gu' && item.gujarati_name) ? item.gujarati_name : item.name;
                    const fontClass = viewLang === 'gu' ? 'font-guj' : '';

                    itemsHtml += `
                        <label class="item-check">
                            <input type="checkbox" class="item-checkbox" value="${item.id}" ${isChecked} onchange="toggleItem(${item.id}, this)">
                            <span class="item-label ${fontClass}">${itemName}</span>
                        </label>
                    `;
                });

                // Restore open state
                const isOpen = openCats.includes(`cat-body-${cat.id}`);
                const openClass = isOpen ? 'open' : '';
                const activeClass = isOpen ? 'active' : '';

                const html = `
                    <div class="category-card">
                        <div class="cat-header ${activeClass}" onclick="toggleCategory(${cat.id})">
                            <span class="${viewLang==='gu'?'font-guj':''}">${catName}</span>
                            <span style="font-size:12px; color:#999;">${catItems.length}</span>
                        </div>
                        <div class="cat-body ${openClass}" id="cat-body-${cat.id}">
                            <div class="item-grid">${itemsHtml}</div>
                            <textarea class="custom-area" placeholder="${viewLang==='gu' ? '‡™Ö‡™®‡´ç‡™Ø ‡™µ‡™∏‡´ç‡™§‡´Å‡™ì ‡™â‡™Æ‡´á‡™∞‡´ã...' : 'Add custom items (optional)...'}" id="custom-${cat.id}"></textarea>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function toggleCategory(id, forceOpen = false) {
            const body = document.getElementById(`cat-body-${id}`);
            const header = body.previousElementSibling;
            if (forceOpen) {
                body.classList.add('open');
                header.classList.add('active');
            } else {
                body.classList.toggle('open');
                header.classList.toggle('active');
            }
        }

        function toggleItem(id, checkbox) {
            if (checkbox.checked) selectedItems.add(id);
            else selectedItems.delete(id);
            updateStats();
        }

        function updateStats() {
            document.getElementById('count-items').innerText = selectedItems.size;
            const activeCatIds = new Set();
            selectedItems.forEach(iid => {
                const item = allItems.find(x => x.id === iid);
                if(item) activeCatIds.add(item.category);
            });
            document.getElementById('count-cats').innerText = activeCatIds.size;
        }

        // --- 4. PDF GENERATION ---
        async function generatePDF(lang, isPreview) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Gather Data
            let clientName, eventDate, guests, venue, phone;
            
            if (eventId) {
                clientName = currentEventData.title;
                eventDate = currentEventData.date;
                guests = currentEventData.guests;
                venue = currentEventData.venue;
                phone = currentEventData.contact_number;
            } else {
                clientName = document.getElementById('client-name').value;
                if(!clientName) { Swal.fire("Missing Info", "Please enter a Client Name", "warning"); return; }
                eventDate = document.getElementById('event-date').value;
                guests = document.getElementById('guest-count').value;
                venue = document.getElementById('venue-name').value;
                phone = document.getElementById('client-phone').value;
            }

            const note = document.getElementById('menu-note').value;

            // Load Assets
            async function loadImage(url) {
                try {
                    const r = await fetch(url);
                    if(r.ok) return await r.blob().then(b => new Promise(res => { const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b); }));
                } catch(e){} return null;
            }

            try {
                // Load Fonts & Images
                const promises = [
                    loadImage('images/background.png'),
                    loadImage('images/cover.png'),
                    loadImage('images/last.png')
                ];
                
                // Add Font loading if Gujarati
                if (lang === 'gu') {
                    promises.push(
                        fetch('Gujarati.ttf').then(r => r.blob()).then(blob => new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(blob);
                        }))
                    );
                }

                const results = await Promise.all(promises);
                const bg = results[0];
                const cover = results[1];
                const back = results[2];
                
                if (lang === 'gu') {
                    const fontBase64 = results[3];
                    doc.addFileToVFS('Gujarati.ttf', fontBase64);
                    doc.addFont('Gujarati.ttf', 'Gujarati', 'normal');
                    doc.setFont('Gujarati');
                } else {
                    doc.setFont("helvetica", "normal");
                }

                // 1. Cover
                if(cover) {
                    doc.addImage(cover, 'PNG', 0, 0, 210, 297);
                    doc.setTextColor(212, 175, 55); 
                    if(lang !== 'gu') doc.setFont("times", "bold"); 
                    doc.setFontSize(20); 
                    doc.text(`${clientName} - ${formatDate(eventDate)}`, 105, 200, { align: 'center' }); 
                    if(lang === 'gu') doc.setFont('Gujarati'); else doc.setFont("helvetica", "normal");
                    doc.addPage();
                }

                // Header Helper
                function drawHeader() {
                    if(bg) doc.addImage(bg, 'PNG', 0, 0, 210, 297);
                    doc.setDrawColor(212, 175, 55); doc.setLineWidth(0.5);
                    doc.line(15, 43, 195, 43);
                    
                    doc.setFontSize(10); 
                    if(lang !== 'gu') doc.setFont("helvetica", "bold");
                    
                    // Info Grid
                    const y = 48;
                    doc.setTextColor(212, 175, 55); doc.text(lang === 'gu' ? "‡™®‡™æ‡™Æ :" : "Name :", 20, y);
                    doc.setTextColor(0,0,0); doc.text(clientName || "-", 35, y);
                    
                    doc.setTextColor(212, 175, 55); doc.text(lang === 'gu' ? "‡™µ‡´ç‡™Ø‡™ï‡´ç‡™§‡™ø :" : "Guests :", 90, y);
                    doc.setTextColor(0,0,0); doc.text(String(guests || "-"), 105, y);

                    doc.setTextColor(212, 175, 55); doc.text(lang === 'gu' ? "‡™§‡™æ‡™∞‡´Ä‡™ñ :" : "Date :", 20, y+6);
                    doc.setTextColor(0,0,0); doc.text(formatDate(eventDate), 35, y+6);

                    doc.setTextColor(212, 175, 55); doc.text(lang === 'gu' ? "‡™∏‡´ç‡™•‡™≥ :" : "Venue :", 90, y+6);
                    doc.setTextColor(0,0,0); doc.text(venue || "-", 105, y+6);

                    if(phone) {
                        doc.setTextColor(212, 175, 55); doc.text("Phone :", 150, y);
                        doc.setTextColor(0,0,0); doc.text(phone, 165, y);
                    }

                    doc.line(15, y+10, 195, y+10);
                    return y+20;
                }

                let currentY = drawHeader();
                let currentX = 15;
                const midX = 110;

                // Render Categories
                categories.forEach(cat => {
                    // Filter Items
                    const catItems = allItems.filter(i => i.category === cat.id && selectedItems.has(i.id));
                    // Get custom text (might be empty)
                    const customText = document.getElementById(`custom-${cat.id}`).value;
                    
                    if(catItems.length === 0 && !customText.trim()) return;

                    // Get Correct Names
                    const catName = (lang === 'gu' && cat.gujarati_name) ? cat.gujarati_name : cat.name;

                    // Check page break
                    if(currentY > 260) {
                        if(currentX === 15) { currentX = midX; currentY = 68; }
                        else { doc.addPage(); currentY = drawHeader(); currentX = 15; }
                    }

                    // Category Header
                    doc.setFillColor(198, 153, 79); 
                    doc.roundedRect(currentX, currentY-6, 80, 8, 3, 3, 'F');
                    doc.setTextColor(0,0,0); doc.setFontSize(11);
                    if(lang !== 'gu') doc.setFont("helvetica", "bold");
                    doc.text(catName, currentX+5, currentY-1);
                    currentY += 8;

                    // Items
                    if(lang !== 'gu') doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    
                    catItems.forEach(item => {
                        const iName = (lang === 'gu' && item.gujarati_name) ? item.gujarati_name : item.name;
                        doc.text(iName, currentX+5, currentY);
                        currentY += 6;
                    });

                    // Custom Text
                    if(customText) {
                        const lines = doc.splitTextToSize(customText, 80);
                        doc.setTextColor(50,50,50);
                        doc.text(lines, currentX+5, currentY);
                        currentY += (lines.length * 6);
                    }
                    currentY += 4; 
                });

                // Footer Note
                if(note) {
                    if(currentY > 240) { doc.addPage(); currentY = drawHeader(); }
                    doc.setFillColor(255, 252, 245); doc.setDrawColor(198, 153, 79);
                    doc.roundedRect(15, 250, 180, 30, 3, 3, 'FD');
                    doc.setFontSize(10); doc.setTextColor(0,0,0);
                    doc.text((lang==='gu'?"‡™®‡´ã‡™Ç‡™ß: ":"NOTE: ") + note, 20, 258, { maxWidth: 170 });
                }

                // 3. Back Cover
                if(back) { doc.addPage(); doc.addImage(back, 'PNG', 0, 0, 210, 297); }

                const safeName = clientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const fName = `${safeName}_${lang.toUpperCase()}_Menu.pdf`;

                if(isPreview) window.open(doc.output('bloburl'), '_blank');
                else doc.save(fName);

            } catch(e) { console.error(e); Swal.fire("Error", "PDF Generation failed: " + e.message, "error"); }
        }

        // --- 5. SAVE TO DB ---
        async function saveToDatabase() {
            if(!eventId) return; 
            
            const payload = {
                event: eventId,
                title: "Menu " + new Date().toLocaleDateString(),
                items: Array.from(selectedItems),
                note: document.getElementById('menu-note').value,
                is_selected: true
            };

            const url = menuId 
                ? `http://127.0.0.1:8000/api/menu/menus/${menuId}/` 
                : `http://127.0.0.1:8000/api/menu/menus/`;
            
            const method = menuId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    Swal.fire("Saved", "Menu saved successfully!", "success")
                        .then(() => window.location.href = "dashboard.html");
                } else {
                    throw new Error("Save failed");
                }
            } catch(e) { Swal.fire("Error", "Could not save menu.", "error"); }
        }

        function formatDate(d) {
            if(!d) return "";
            try { const p=d.split('-'); return `${p[2]}-${p[1]}-${p[0]}`; } catch(e) { return d; }
        }

        init();
    </script>
</body>
</html>